<html>

<link rel="stylesheet" type="text/css" href="../../lib/css/themes/jquery-ui/redmond/jquery-ui.min.css"/>
<link rel="stylesheet" type="text/css" href="../../lib/css/jqGrid/ui.jqgrid-4.5.4.css"/>
<script type="text/javascript" src="../../lib/js/jquery-1.11.1.min.js"></script>
<script type="text/javascript" src="../../socket.io/socket.io.js"></script>
<script type="text/javascript" src="../../lib/js/jquery-ui-1.10.3.full.min.js"></script>
<script type="text/javascript" src="../../lib/js/jqGrid/jquery.jqGrid-4.5.4.min.js"></script>
<script type="text/javascript" src="../../lib/js/jqGrid/grid.locale-all.js"></script>

<link rel="stylesheet" type="text/css" href="../../css/adapter.css"/>
<!--<link rel="stylesheet" type="text/css" href="../lib/css/adapter.css"/>-->
<script type="text/javascript" src="../../js/translate.js"></script>
<script type="text/javascript" src="../../js/adapter-settings.js"></script>

<style>

.tablemore td {
   font-size: 11px;
}
/*---------------------------------------------*/
.htooltip span { /* Внешний вид нашего тултипа */
	background-color: rgba(245,237,1, 0.9);
	border-radius: 15px 15px 15px 0px;
	box-shadow: 1px 1px 10px rgba(0, 0, 0, 0.5);
	color: black;
	margin-left: -600px;
	margin-top: -275px;
	opacity: 0; /* Делаем его прозрачным */
	padding: 10px 10px 10px 40px;
	position: absolute;
	text-decoration: none;
	visibility: hidden; /* И прячем */
	width: 750px;
	z-index: 10;
        font-size: 11px;
}
		
.htooltip:hover span { /* По hover отображаем тултип */
	opacity: 1;
	visibility: visible;
}
		
.htooltip span img { /* Изображение для примера */
	border: 0 none;
	float: left;
	margin: -71px 0 0 -234px;
	opacity: 0;
	position: absolute;
	visibility: hidden;
	z-index: -1;
}
		
.htooltip:hover span img { /* Показываем изображение */
	opacity: 1;
	visibility: visible;
}

/* ------------------------------------------------*/
/*
span.tooltip {
  padding: 0px 5px;
  position: relative;
  background: #FFBB99;
  cursor: pointer;
}

.tooltip-info {
  position: absolute;
  top: -9999px;
  left: -9999px;
}

span.tooltip::before {
  content: attr(data-tooltip);
  position: absolute;
  top: 1.5em;
  font-size: 0.9em;
  padding: 1px 5px;
  display: none;
  color: white;
  background: rgba(0, 0, 0, 0.75);
  border-radius: 4px;
  transition: opacity 0.1s ease-out;
  z-index: 99;
  text-align: left;
}

span:hover::before {
  display: inline-block;
}
  */
/* Cначала обозначаем стили для IE8 и более старых версий
т.е. здесь мы немного облагораживаем стандартный чекбокс. */
.checkbox {
  vertical-align: top;
  margin: 0 3px 0 0;
  width: 17px;
  height: 17px;
}
/* Это для всех браузеров, кроме совсем старых, которые не поддерживают
селекторы с плюсом. Показываем, что label кликабелен. */
.checkbox + label {
  cursor: pointer;
}

/* Далее идет оформление чекбокса в современных браузерах, а также IE9 и выше.
Благодаря тому, что старые браузеры не поддерживают селекторы :not и :checked,
в них все нижеследующие стили не сработают. */

/* Прячем оригинальный чекбокс. */
.checkbox:not(checked) {
  position: absolute;
  opacity: 0;
}
.checkbox:not(checked) + label {
  position: relative; /* будем позиционировать псевдочекбокс относительно label */
  padding: 0 0 0 60px; /* оставляем слева от label место под псевдочекбокс */
}
/* Оформление первой части чекбокса в выключенном состоянии (фон). */
.checkbox:not(checked) + label:before {
  content: '';
  position: absolute;
  top: -4px;
  left: 0;
  width: 50px;
  height: 26px;
  border-radius: 13px;
  background: #CDD1DA;
  box-shadow: inset 0 2px 3px rgba(0,0,0,.2);
}
/* Оформление второй части чекбокса в выключенном состоянии (переключатель). */
.checkbox:not(checked) + label:after {
  content: '';
  position: absolute;
  top: -2px;
  left: 2px;
  width: 22px;
  height: 22px;
  border-radius: 10px;
  background: #FFF;
  box-shadow: 0 2px 5px rgba(0,0,0,.3);
  transition: all .2s; /* анимация, чтобы чекбокс переключался плавно */
}
/* Меняем фон чекбокса, когда он включен. */
.checkbox:checked + label:before {
  background: #9FD468;
}
/* Сдвигаем переключатель чекбокса, когда он включен. */
.checkbox:checked + label:after {
  left: 26px;
}
/* Показываем получение фокуса. */
.checkbox:focus + label:before {
  box-shadow: 0 0 0 3px rgba(255,255,0,.5);
}

.no-space {
        border: 0px !important;
        margin: 0px;
        padding: 0px;
        border-spacing: 0px;
        border-image-width: 0px;
    }
.round {
        padding: 30px;
        background: lightyellow;
        border: 1px solid #939393;
        border-radius: 30px;
       }
.round1 {
        padding: 30px;
        margin: 30px;
        border-spacing: 10px;
        background: lightyellow;
        border: 1px solid #939393;
        border-radius: 30px;
        position: relative;
       }
    .roundmore {
        padding: 30px;
        margin: 5px;
        border-spacing: 2px;
        background: lightgreen;
        border: 1px solid #939393;
        border-radius: 30px;
        display:block;
        left: 610px; /* 670 */
        top: 0px;        
        float: right;
        position: absolute;
        width: 450px; /* -- */ 
       }
     @-webkit-keyframes rainbow {
        0%   {background: gold}
        50%  {background: yellow}
        100% {background: gold}
    }
    @keyframes rainbow {
        0%   {background: gold}
        50%  {background: yellow}
        100% {background: gold}
    }
    #stolik { 
      webkit-animation: rainbow 2s linear 2s infinite;
      animation: rainbow 2s linear 2s infinite;     
    }
.circlexpnew {
    position: absolute;
    z-index: 1;
    opacity: 0.4;
    width: 20px;
    height: 40px;
    display: block;
    border-radius: 50px;
    -moz-border-radius: 50px;
    -webkit-border-radius: 50px;
    -khtml-border-radius: 50px;
    font-size: 24px;
    color: darkblue;
    line-height: 10px;
    text-align: center;
    background: yellow;
    padding: 0 1em;
}
.circlexp {
    position: absolute;
    z-index: 1;
    opacity: 0.4;
    width: 50px;
    height: 91px;
    display: block;
    border-radius: 50px;
    -moz-border-radius: 50px;
    -webkit-border-radius: 50px;
    -khtml-border-radius: 50px;
    font-size: 24px;
    color: darkblue;
    line-height: 50px;
    text-align: center;
    background: yellow;
    padding: 0 1em;
}
    .xt2_port {
        padding: 0px;
        opacity: 0.5;
        margin: 0px;
        border-spacing: 2px;
        background: yellow;
        border: 1px solid #939393;
        border-radius: 3px;
        display:block;
        left: 0px;
        top: 0px;        
        position: absolute;
        height: 85px;
       }
    .translateB {
        font-size: 10px;
        height: 40px;
    }
    .circlebutton_darkgreen{
        width:16px;
        height:16px;
        display:block;
        border: 1px solid #939393;
        border-radius:10px;
        -moz-border-radius:10px;
        -webkit-border-radius:10px;
        -khtml-border-radius:10px; font-size:2px;
        color:#fff;
        line-height:16px;
        text-align:center;
        background:darkgreen;
     }
    .circlebutton_green{
        width:16px;
        height:16px;
        border: 1px solid #939393;
        display:block;
        border-radius:10px;
        -moz-border-radius:10px;
        -webkit-border-radius:10px;
        -khtml-border-radius:10px; font-size:2px;
        color:#fff;
        line-height:16px;
        text-align:center;
        background:greenyellow;
     }
    .circlebutton_darkred{
        width:16px;
        height:16px;
        display:block;
        border: 1px solid #939393;
        border-radius:10px;
        -moz-border-radius:10px;
        -webkit-border-radius:10px;
        -khtml-border-radius:10px; font-size:2px;
        color:#fff;
        line-height:16px;
        text-align:center;
        background:darkred;
     }
    .circlebutton_red{
        width:16px;
        height:16px;
        display:block;
        border: 1px solid #939393;
        border-radius:10px;
        -moz-border-radius:10px;
        -webkit-border-radius:10px;
        -khtml-border-radius:10px; font-size:2px;
        color:#fff;
        line-height:16px;
        text-align:center;
        background:red;
     }
    .circlebutton1{
        width:16px;
        height:16px;
        display:block;
        border-radius:10px;
        border: 1px solid #939393;
        -moz-border-radius:10px;
        -webkit-border-radius:10px;
        -khtml-border-radius:10px; font-size:2px;
        color:#fff;
        line-height:16px;
        text-align:center;
        background:gold;
        webkit-animation: rainbow 0.5s linear 0.5s infinite;
        animation: rainbow 0.5s linear 0.5s infinite;     
     }
     .sd7i7or {
        position: absolute;
        z-index: 2;
        height: 20px;
        padding: 23px 1em;
     }
     .dxp {
        position: relative; 
        z-index: 0; 
        width: 700px; 
        top: 0px; 
        left: 0px; 
        padding: 0 1em; 
        float: left;
     }
</style>

<script type="text/javascript">
    systemDictionary = {
        "MegaD Name:":          {"en": "MegaD Name:",           "de": "MegaD Name:",                "ru": "MegaD Имя:"},
        "ioBroker Web Port:":   {"en": "ioBroker Web Port:",    "de": "ioBroker Web Port:",         "ru": "ioBroker веб-порт:"},
        "Poll interval (sec):": {"en": "Poll interval (sec):",  "de": "Abfrage Intervall (sek):",   "ru": "Интервал опроса (сек):"},
        "MegaD Password:":      {"en": "MegaD Password:",       "de": "MegaD Kennword:",            "ru": "MegaD Пароль:"},
        "name":                 {"en": "Name",                  "de": "Name",                       "ru": "Имя"},
        "input":                {"en": "Input",                 "de": "Eingang",                    "ru": "Вход"},
        "switch":               {"en": "Switch",                "de": "Schalter",                   "ru": "Переключатель"},
        "offset":               {"en": "Offset",                "de": "Offset",                     "ru": "Сдвиг"},
        "factor":               {"en": "Factor",                "de": "Factor",                     "ru": "Множитель"},
        "digital":              {"en": "Digital",               "de": "Digital",                    "ru": "Цифровой"},
        "long":                 {"en": "Long press",            "de": "Long press",                 "ru": "Удержание"},
        "double":               {"en": "Double click ms",       "de": "Double click ms",            "ru": "Двойное нажатие"},
        "Ports":                {"en": "Ports",                 "de": "Ports",                      "ru": "Порты"},
        "Long press detect (ms):": {"en": "Long press detection (ms):", "de": "Langes-Drucken-Erkennung (ms):", "ru": "Интервал для длинного нажатия (мс):"},
        "MegaD-2561 adapter settings": {"en": "MegaD-2561 adapter settings", "de": "MegaD-2561 Adaptereinstellungen", "ru": "MegaD-2561 настройки"},
        "IP:":                  {"en": "MegaD IP:",             "de": "MegaD IP:",                  "ru": "IP Адрес устройства:"},
        "Double press detect (ms):": {"en": "Double press detect (ms):", "de": "Doppelclick-Interval(ms):", "ru": "Интервал двойного нажатия (мс):"},
        "Add new port":         {"en": "Add new port",          "de": "Neuer Port",                 "ru": "Добавить порт"},
        "Auto detect ports":    {"en": "Auto detect ports",     "de": "Auto-Detekt die Ports",      "ru": "Считать настройки с MegaD"},
        "Write config to device": {"en": "Write config to device", "de": "Konfiguration in das Gerät schreiben", "ru": "Записать настройки в устройство"},
        "Name":                 {"en": "Name",                  "de": "Name",                       "ru": "Имя"},
        "Room":                 {"en": "Room",                  "de": "Zimmer",                     "ru": "Комната"},
        "Role":                 {"en": "Role",                  "de": "Rolle",                      "ru": "Роль"},
        "Type":                 {"en": "Type",                  "de": "Typ",                        "ru": "Тип"},
        "Mode":                 {"en": "Mode",                  "de": "Modus",                      "ru": "Режим"},
        "NC":                   {"en": "Not configured",        "de": "nicht benutzt",              "ru": "Не подключено"},
        "Input":                {"en": "Input",                 "de": "Input",                      "ru": "Стандартный вход"},
        "Output":               {"en": "Output",                "de": "Output",                     "ru": "Стандартный выход"},
        "ADC":                  {"en": "Analog in (ADC)",       "de": "Analog in (ADC)",            "ru": "Ан. вход (ADC)"},
        "Digital Sensor":       {"en": "Digital Sensor",        "de": "Digital Sensor",             "ru": "Циф. датчик"},
        "I2C Bus":              {"en": "I2C Bus",               "de": "I2C Bus",                    "ru": "Шина I2C"},
        "normal opened":        {"en": "normal opened",         "de": "bei schliessen",             "ru": "при замыкании"},
        "on change":            {"en": "on change",             "de": "auf änderung",               "ru": "при изменении"},
        "normal closed":        {"en": "normal closed",         "de": "bei auf",                    "ru": "при размыкании"},
        "click mode":           {"en": "click mode",            "de": "presse modus",               "ru": "режим нажатия"},
        "Action:":              {"en": "Action:",               "de": "Aktion:",                    "ru": "Сценарий:"},
        "Net:":                 {"en": "Net:",                  "de": "Net:",                       "ru": "Сетевой сценарий:"},
        "Long:":                {"en": "Long:",                 "de": "Lang-Click:",                "ru": "Долгое нажатие:"},
        "Double:":              {"en": "Double:",               "de": "Double-Click:",              "ru": "Двойное нажатие:"},
        "SCL:":                 {"en": "SCL port:",             "de": "SCL port:",                  "ru": "SCL порт:"},
        "Disp:":                {"en": "Display port:",         "de": "Anzeigen port:",             "ru": "Дисплей порт:"},
        "not monitored":        {"en": "not monitored",         "de": "nicht beobachtet",           "ru": "не наблюдать"},
        "> threshold":          {"en": "> threshold",           "de": "> Schwellwert",              "ru": "> порога"},
        "< threshold":          {"en": "< threshold",           "de": "< Schwellwert",              "ru": "< порога"},
        "<> threshold":         {"en": "<> threshold",          "de": "<> Schwellwert",             "ru": "<> порога"},
        "Offset:":              {"en": "Offset:",               "de": "Offset:",                    "ru": "Сдвиг:"},
        "Factor:":              {"en": "Factor:",               "de": "Faktor:",                    "ru": "Множитель:"},
        "DHT11":                {"en": "DHT11",                 "de": "DHT11",                      "ru": "DHT11"},
        "DHT22":                {"en": "DHT22",                 "de": "DHT22",                      "ru": "DHT22"},
        "PWM":                  {"en": "PWM",                   "de": "PWM",                        "ru": "ШИМ"},
        "DS2413":               {"en": "DS2413",                "de": "DS2413",                     "ru": "DS2413"},
        "HTU21D":               {"en": "HTU21D",                "de": "HTU21D",                     "ru": "HTU21D"},
        "BH1750":               {"en": "BH1750",                "de": "BH1750",                     "ru": "BH1750"},
        "TSL2591":              {"en": "TSL2591",               "de": "TSL2591",                    "ru": "TSL2591"},
        "SSD1306":              {"en": "SSD1306",               "de": "SSD1306",                    "ru": "SSD1306"},
        "MCP23008":             {"en": "MCP23008",              "de": "MCP23008",                   "ru": "MCP23008"},
        "ANY":                  {"en": "Any",                   "de": " Alle",                      "ru": "Любой"},
        "Scan":                 {"en": "Scan",                  "de": "Scan",                       "ru": "Поиск"},
        "SDA":                  {"en": "SDA",                   "de": "SDA",                        "ru": "SDA"},
        "SCL":                  {"en": "SCL",                   "de": "SCL",                        "ru": "SCL"},
        "Frequency:":           {"en": "Frequency:",            "de": "Frequenz:",                  "ru": "Частота:"},
        "Default state:":       {"en": "Default state:",        "de": "Default Zustand:",           "ru": "По умолчанию:"},
        "off":                  {"en": "off",                   "de": "off",                        "ru": "выкл"},
        "on":                   {"en": "on",                    "de": "on",                         "ru": "вкл"},
        "Norm":                 {"en": "Norm",                  "de": "Norm",                       "ru": "Норма"},
        "Low":                  {"en": "Low",                   "de": "Niedrig",                    "ru": "Низкая"},
        "High":                 {"en": "High",                  "de": "Hoch",                       "ru": "Высокая"},
        "Threshold:":           {"en": "Threshold:",            "de": "Schwellwert:",               "ru": "Порог:"},
        "Hysteresis:":          {"en": "Hysteresis:",           "de": "Hysterese:",                 "ru": "Гистерезис:"},
        "Smooth:":              {"en": "Smooth:",               "de": "Glatt:",                     "ru": "Плавный:"},
        "Change ip or password": {
            "en": "Change ip or password",
            "de": "IP Adresse oder Kennwort ändern",
            "ru": "Изменить IP или пароль"
        },
         "Take new settings into config:": {
             "en": "Take new settings into config:",
             "de": "Neue Einstellungen übernehmen:",
             "ru": "Перенять новые настройки:"
         },
         "Old IP:":             {"en": "Old IP:",               "de": "Alte IP:",                   "ru": "Старый IP:"},
         "Old password:":       {"en": "Old password:",         "de": "Altes Kennwort:",            "ru": "Старый пароль:"},
         "New IP:":             {"en": "New IP:",               "de": "Neue IP:",                   "ru": "Новый IP:"},
         "New password:":       {"en": "New password:",         "de": "Neues Kennwort:",            "ru": "Новый пароль:"},
         "Set new password or IP address": {
             "en": "Set new password or IP address",
             "de": "Set new password or IP address",
             "ru": "Изменить IP или пароль на устройстве"
         },
        "Ok":                   {"en": "Ok",                    "de": "Ok",                         "ru": "Ok"},
        "Cancel":               {"en": "Cancel",                "de": "Abrechen",                   "ru": "Отмена"},
        "Error":                {"en": "Error",                 "de": "Fehler",                     "ru": "Ошибка"},
        "Find devices":         {"en": "Find devices",          "de": "Suche Geräte",               "ru": "Искать устройства"},
        "Nothing found":        {"en": "Nothing found",         "de": "Nichts gefunden",            "ru": "Ничего не найдено"},
        "PWM:":                 {"en": "PWM:",                  "de": "PWM:",                       "ru": "PWM:"},
        "Sensor type:":         {"en": "Sensor type:",          "de": "Sensortyp:",                 "ru": "Тип сенсора:"},
        "Dev:":                 {"en": "Sensor type:",          "de": "Sensortyp:",                 "ru": "Тип сенсора:"},
        "De-bounce:":           {"en": "De-bounce:",            "de": "Entprellen:",                "ru": "Дребезг:"},
        "Current firmware version:":    {"en": "Current Firmware version:",     "de": "Current Firmware version:",          "ru": "Текущая версия прошивки:"},
        "Last known firmware version:":    {"en": "Last known Firmware version:",     "de": "Last known Firmware version:",          "ru": "Свежая версия прошивки:"},
        "Update Firmware":      {"en": "Update Firmware",       "de": "Update Firmware",            "ru": "Перепрошить Мегу"},
        "Firmware updated":     {"en": "Firmware updated",      "de": "Firmware updated",           "ru": "Мега перепрошита"},
        "SMS Setup":            {"en": "SMS Setup",             "de": "SMS",                        "ru": "Настройки SMS"}
    };
   var onchange  = null;
   var rooms     = [];
   var ports     = [];
   var functions = [];
   var active    = false;
   var megadjt_setup = [];   

//   var portState = [];

var cPortType_NotConnected = 'NotConnected'; //255
var cPortType_StandartIn  = 'StandartIn';    //0
var cPortType_ReleOut = 'ReleOut';           //1
var cPortType_DimmedOut = 'DimmedOut'; //1
var cPortType_SimistorOut = 'SimistorOut'; //1
var cPortType_DigitalSensor  = 'DigitalSensor'; //3 цифровой вход dsen
var cPortType_I2C  = 'I2C'; // 4 
var cPortType_AnalogSensor  = 'AnalogSensor'; // 2 АЦП-вход для аналоговых датчиков


   //------------------------------------------------------------------------------------------------
   function getFirmwareVersion () {
      var fw_version = "";
      var fw_version_last_known = "";

      //socket.emit('getState',  adapter + '.' + instance + '.fw_version', function (err, state) {
      socket.emit('getState',  adapter + '.' + instance + '.firmware.version', function (err, state) {
         fw_version = state.val;
         $('#fw_version').val(fw_version);

         //socket.emit('getState',  adapter + '.' + instance + '.fw_version_last_known', function (err, state) {
         socket.emit('getState',  adapter + '.' + instance + '.firmware.last_known_version', function (err, state) {
            fw_version_last_known = state.val;
            $('#fw_version_last_known').val(fw_version_last_known);
            if  ( fw_version === fw_version_last_known ) {
               document.getElementById( 'fw_version' ).style.backgroundColor = "lightgreen";
               document.getElementById( 'fw_version_last_known' ).style.backgroundColor = "lightgreen";
            } else {
               document.getElementById( 'fw_version' ).style.backgroundColor = "yellow";
               document.getElementById( 'fw_version_last_known' ).style.backgroundColor = "pink";
            }
            //onchange();  
         });
      });
   }

   //--------------------------------------------------------------------------------
    function smsApiKeyChanged ( ) {
      var newkey = $('#sms_apiKey').val();
      var obj = {  val: newkey, ack: true };
                  
//      socket.emit('setState',  adapter + '.' + instance + '.sms.apiKey', newkey, true );
      socket.emit('setState',  adapter + '.' + instance + '.sms.apiKey', obj );
      //http://192.168.1.35:8087/set/megadjt.0.sms.apikey0?value=123&prettyPrint
    }

   //--------------------------------------------------------------------------------
    function smsPhonesChanged ( ) {
      var newkey = $('#sms_phones').val();
      var obj = {  val: newkey, ack: true };
                  
      socket.emit('setState',  adapter + '.' + instance + '.sms.phones', obj );
      //http://192.168.1.35:8087/set/megadjt.0.sms.apikey0?value=123&prettyPrint
    }

   //--------------------------------------------------------------------------------
    function smsEnabledChanged ( ) {
      var newkey = false;
      if ( $('#sms_enabled').prop('checked') ) {
         newkey = true;
      } 
      var obj = {  val: newkey, ack: true };
                  
      socket.emit('setState',  adapter + '.' + instance + '.sms.enabled', obj );
      //http://192.168.1.35:8087/set/megadjt.0.sms.apikey0?value=123&prettyPrint
    }


   //--------------------------------------------------------------------------------
   function getAdapterStates () {
      var sms_apiKey  = "";
      var sms_enabled = false;
      var sms_phones  = "";
      var portstate;

      for ( var i = 0; i <= 37; i ++ ) {
         //socket.emit('getState',  adapter + '.' + instance + '.ports.' + i + '.portType', function (err, state, i ) {
         //portstate = cPortType_NotConnected;
         getState( adapter + '.' + instance + '.ports.' + i + '.portType', function (err, state ) {
             var z = state.val;
             $('#tmp').val( z );
           });

         portstate = $('#tmp').val();

         $( '#portState' + i ).val( portstate );
         $( '#portState' + i + '.value' ).val( portstate );

         //onchange();
      }

      socket.emit('getState',  adapter + '.' + instance + '.sms.apiKey', function (err, state) {
         sms_apiKey = state.val;
         $('#sms_apiKey').val(sms_apiKey);
         $('#sms_apiKey').change(smsApiKeyChanged);
         onchange();  
      });

      socket.emit('getState',  adapter + '.' + instance + '.sms.enabled', function (err, state) {
         sms_enabled = state.val;
         if (sms_enabled == true || sms_enabled == 'true' ) {
            //$('#sms_enabled').prop('checked');            
            /// $('#sms_enabled').setAttribute('checked','checked');
            $('#sms_enabled').prop('checked', true);
            //$('#sms_enabled').checked = true;
            //$('#sms_enabled').prop('checked') = true;
            //$('#sms_enabled').setAttr('checked','checked');
         } else {
            $('#sms_enabled').removeAttr('checked');
         }
         $('#sms_enabled').change(smsEnabledChanged);
         onchange();  
      });

      socket.emit('getState',  adapter + '.' + instance + '.sms.phones', function (err, state) {
         sms_phones = state.val;
         $('#sms_phones').val(sms_phones);
         $('#sms_phones').change(smsPhonesChanged);
         onchange();  
      });

      socket.emit('getState',  adapter + '.' + instance + '.controller.xp1model', function (err, state) {
         //$('#xp1text').val(state.val);
         $('#xp1model').val(state.val);
         $('#xp1model option:selected').val(state.val);
         $("#xp1model select").val(state.val);
         $('#xp1model option').each(function() {
             if($(this).val() == state.val) {
                 $(this).prop("selected", true);
             }
         });

         onchange();  
      });

      socket.emit('getState',  adapter + '.' + instance + '.controller.xp2model', function (err, state) {
         $('#xp2model option:selected').val(state.val);
         $('#xp2model').val(state.val);
         $("#xp2model select").val(state.val);
         $('#xp2model option').each(function() {
             if($(this).val() == state.val) {
                 $(this).prop("selected", true);
             }
         });
         onchange();
      });
  
      //onchange();
      //showXP( 1 );
      //showXP( 2 );
      //showXP( 0 );
   }


   //------------------------------------------------------------------------------------------------
   function showOnePort(index, portSettings) {
      // name, room, role, pty(type), ecmd(Action), eth(net action), m(mode), d(default state), pwm(0-255), misc (threshold)
      var text = '<tr class="tspace">';
      // index
      ///text += '<td class="tspace">' + ((index == 14 || index == 15) ? ('A' + (index - 8)) : ('P' + index)) + '</td>';
      text += '<td class="tspace">' + ((index == 37) ? ('P' + index) : ('P' + index)) + '</td>';
      // name
      text += '<td class="tspace"><input class="tvalue" type="text" data-type="name" data-port="' + index + '" value="' + (portSettings.name || '') + '" style="width: 100%"/></td>';
      // room
      text += '<td class="tspace"><select class="tvalue" data-type="room" data-port="' + index + '" style="width: 100%"><option value=""></option>';

      for (var r in rooms) {
         text += '<option value="' + r + '" ' + ((portSettings.room == r) ? 'selected' : '') + '>' + rooms[r].common.name + '</option>';
      }
      text += '</td>';

      // role
      text += '<td class="tspace"><input class="tvalue" type="text"  data-type="role" data-port="' + index + '" value="' + (portSettings.role || '') + '" style="width: 100%"/></td>';

      // type
      ///text += '<td class="tspace"><select class="tvalue" ' + (((index == 14 || index == 15) && portSettings.pty == 2) ? 'disabled' : '') + ' data-type="pty" data-port="' + index + '" style="width: 100%">';
      text += '<td class="tspace"><select class="tvalue" ' + ' data-type="pty" data-port="' + index + '" style="width: 100%">';
      text += '<option value="255" ' + ((portSettings.pty == 255) ? 'selected' : '') + '>' + _('NC')              + '</option>';
      text += '<option value="0" '   + ((portSettings.pty == 0)   ? 'selected' : '') + '>' + _('Input')           + '</option>';
      text += '<option value="1" '   + ((portSettings.pty == 1)   ? 'selected' : '') + '>' + _('Output')          + '</option>';
      if (index == 0 || index == 1 || index == 2 || index == 3 || index == 4 || index == 5 || index == 36 || index == 37) {
         text += '<option value="2" '   + ((portSettings.pty == 2)   ? 'selected' : '') + '>' + _('ADC')         + '</option>';
      }
      text += '<option value="3" '   + ((portSettings.pty == 3)   ? 'selected' : '') + '>' + _('Digital Sensor')  + '</option>';
      text += '<option value="4" '   + ((portSettings.pty == 4)   ? 'selected' : '') + '>' + _('I2C Bus')  + '</option>';
      text += '</td>';

      // mode
      var modes = null;
      if (portSettings.pty == 0) {
         modes = [
                'normal opened',
                'on change',
                'normal closed',
                'click mode'
            ];
      } else if (portSettings.pty == 1) {
         if (index == 10 || index == 11 || index == 12 || index == 13 || index == 25  || index == 27  || index == 28) {
            modes = [
                'switch',
                'PWM',
                'DS2413'
             ];
         } else {
            modes = [
                'switch',
                '',
                'DS2413'
               ];
         }
      } else if (portSettings.pty == 2 || (portSettings.pty == 3 && portSettings.d == 3)) {
            modes = [
                'not monitored',
                '> threshold',
                '< threshold',
                '<> threshold'
            ];
      } else if (portSettings.pty == 4) {
            modes = [
                'NC',
                'SDA',
                'SCL'
            ];   
      }
      if (modes) {
         text += '<td class="tspace"><select class="tvalue" data-type="m" data-port="' + index + '">';

         for (var m = 0; m < modes.length; m++) {
            text += '<option value="' + m + '" ' + ((portSettings.m == m) ? 'selected' : '') + '>' + _(modes[m]) + '</option>';
         }
         text += '</select</td>';
      } else {
         text += '<td class="tspace"></td>';
      }
      // buttons
      text += '<td class="tspace"><table class="no-space"><tr class="no-space">';
      text += '<td class="no-space"><button data-port="' + index + '" class="btn-delete"></button></td>';
      text += index ? '<td class="no-space"><button data-port="' + index + '" class="btn-up"></button></td>' : '<td class="no-space"><div style="width: 24px"> </div></td>';
      text += (index != ports.length - 1) ? '<td class="no-space"><button data-port="' + index + '" class="btn-down"></button></td>' : '<td class="no-space"></td>';

      text += '</tr></table></td>';

      text += '<td class="tspace">';
        
      // raw
      if (portSettings.pty == 0) {
         text += ' <input type="checkbox" class="tvalue" data-type="misc" data-port="' + index + '" ' + (portSettings.misc   ? 'checked' : '') + '/>, ';
      }

      // ecmd(Action) and eth(net action)
      ///if (portSettings.pty == 0 || portSettings.pty == 2 || (portSettings.pty == 3 && portSettings.d != 1 && portSettings.d != 2)) {
      if (portSettings.pty == 0 || portSettings.pty == 2 || (portSettings.pty == 3 && (portSettings.d == 3 || portSettings.d == 4))) {
         // ecmd(Action)
         text += _('Action:') + ' <input class="tvalue" data-type="ecmd" type="text" data-port="' + index + '" value="' + (portSettings.ecmd || '') + '"  style="width: 70px" maxsize="11"/>, ';
         text += ' <input type="checkbox" class="tvalue" data-type="af" data-port="' + index + '" ' + (portSettings.af   ? 'checked' : '') + '/>';
         // eth(net action)
         text += _('Net:') + ' <input class="tvalue" data-type="eth" type="text" data-port="' + index + '" value="' + portSettings.eth  + '" style="width: 70px" maxsize="35"/>';
         text += ' <input type="checkbox" class="tvalue" data-type="naf" data-port="' + index + '" ' + (portSettings.naf   ? 'checked' : '') + '/>';
      }

      //d(default state)
      if (portSettings.pty == 1) {
         ///if (portSettings.m) {
         ///portSettings.d = 0;
         ///} else {
         if (portSettings.m == 0) {
            text += _('Default state:') + ' <select class="tvalue" data-type="d" data-port="' + index + '">';
            text += '<option value="0" ' + ((portSettings.d == 0) ? 'selected' : '') + '>' + _('off') + '</option>';
            text += '<option value="1" ' + ((portSettings.d == 1) ? 'selected' : '') + '>' + _('on') + '</option>';
            text += '</select>';
            ///}
         } else if (portSettings.m == 1) {
            text += _('Default state:') + ' <input class="tvalue" data-type="d" type="text" data-port="' + index + '" value="' + (portSettings.d || 0) + '" size=4 maxsize="3"/>';
         }   
   
      } else if (portSettings.pty == 0) {
            ///text += _('De-bounce:') + ' <input type="checkbox" class="tvalue" data-type="d" data-port="' + index + '"/>';
            text += ', ' + _('De-bounce:') + ' <input type="checkbox" class="tvalue" data-type="d" data-port="' + index + '" ' + (portSettings.d   ? 'checked' : '') + '/>';
        }

        //Sensor type
        if (portSettings.pty == 3) {
            modes = [
                'DHT11',
                'DHT22',
                '1W',
                '1WBUS',
                'iB'
            ];
            text += _('Sensor type:') + ' <select class="tvalue" data-type="d" data-port="' + index + '">';
            text += '<option value="1" ' + ((portSettings.d == 1) ? 'selected' : '') + '>DHT11</option>';
            text += '<option value="2" ' + ((portSettings.d == 2) ? 'selected' : '') + '>DHT22</option>';
            text += '<option value="3" ' + ((portSettings.d == 3) ? 'selected' : '') + '>1W</option>';
            text += '<option value="5" ' + ((portSettings.d == 5) ? 'selected' : '') + '>1WBUS</option>';
            text += '<option value="4" ' + ((portSettings.d == 4) ? 'selected' : '') + '>iButton</option>';
            text += '</select>';
        }
        //pwm or smooth
        if (portSettings.pty == 1 && portSettings.m == 1 && (index == 10 || index == 11 || index == 12 || index == 13 || index == 25  || index == 27  || index == 28)) {
            ///text += _('PWM:') + ' <input class="tvalue" data-type="pwm" type="text" data-port="' + index + '" value="' + (portSettings.pwm || 0) + '" size=4 maxsize="3"/>';
            text += ', ' + _('Smooth:') + ' <input type="checkbox" class="tvalue" data-type="misc" data-port="' + index + '" ' + (portSettings.misc   ? 'checked' : '') + '/> ';
            if (portSettings.misc == 1) {
                text += ' <input class="tvalue" data-type="m2" type="text"  style="width: 70px" data-port="' + index + '" value="' + (portSettings.m2 || 1) + '" maxsize="3"/>';
            }
        }
        
        //freq
        if (portSettings.pty == 1 && portSettings.m == 1 && (index == 10 || index == 11 || index == 12 || index == 13 || index == 25  || index == 27  || index == 28)) {
            text += ', ' + _('Frequency:') + ' <select class="tvalue" data-type="fr" data-port="' + index + '">';
                text += '<option value="0" ' + ((portSettings.fr == 0) ? 'selected' : '') + '>' + _('Norm') + '</option>';
                text += '<option value="1" ' + ((portSettings.fr == 1) ? 'selected' : '') + '>' + _('Low') + '</option>';
                text += '<option value="2" ' + ((portSettings.fr == 2) ? 'selected' : '') + '>' + _('High') + '</option>';
                text += '</select>';
        }

        //misc or hst
        if ((portSettings.pty == 2 && portSettings.m != 0) || (portSettings.pty == 3 && portSettings.d == 3 && portSettings.m != 0)) {
            text += ', ' + _('Threshold:') + ' <input class="tvalue" data-type="misc" type="text"  style="width: 70px" data-port="' + index + '" value="' + (portSettings.misc || 0) + '" maxsize="3"/>, ';
            text += _('Hysteresis:') + ' <input class="tvalue" data-type="hst" type="text"  style="width: 70px" data-port="' + index + '" value="' + (portSettings.hst || 0) + '" maxsize="3"/>';
        }
        
        if (portSettings.pty == 2 || (portSettings.pty == 1 && portSettings.m == 1 && (index == 10 || index == 11 || index == 12 || index == 13 || index == 25  || index == 27|| index == 28))) {
            text += ', ' + _('Offset:') + ' <input class="tvalue" data-type="offset" type="text" data-port="' + index + '" style="width: 30px" value="' + (portSettings.offset || 0) + '"/>, ';
            text += _('Factor:') + ' <input class="tvalue" data-type="factor" type="text" data-port="' + index + '" style="width: 30px" value="' + (portSettings.factor || 1) + '"/>';
        }

        //I2C Bus
        if (portSettings.pty == 4 && portSettings.m == 1) {
            text += _('SCL:') + ' <input class="tvalue" data-type="misc" type="text" style="width: 70px" data-port="' + index + '" value="' + (portSettings.misc || 0) + '" maxsize="3"/>';
            text += ', ' + _('Dev:') + ' <select class="tvalue" data-type="d" data-port="' + index + '">';
            text += '<option value="0" ' + ((portSettings.d == 0) ? 'selected' : '') + '>' + _('Unk') + '</option>';
            text += '<option value="1" ' + ((portSettings.d == 1) ? 'selected' : '') + '>' + _('HTU21D') + '</option>';
            text += '<option value="2" ' + ((portSettings.d == 2) ? 'selected' : '') + '>' + _('BH1750') + '</option>';
            text += '<option value="3" ' + ((portSettings.d == 3) ? 'selected' : '') + '>' + _('TSL2591') + '</option>';
            text += '<option value="20" ' + ((portSettings.d == 20) ? 'selected' : '') + '>' + _('MCP23008') + '</option>';
            text += '</select>';
        }
        
        if (portSettings.pty == 0) {
            if (portSettings.m == 1) {
                text += ', ' + _('Long:')   + ' <input type="checkbox" class="tvalue" data-type="long" data-port="' + index + '" ' + (portSettings.long   ? 'checked' : '') + '/>';
            }
            text += ', ' + _('Double:') + ' <input type="checkbox" class="tvalue" data-type="double" data-port="' + index + '" ' + (portSettings.double ? 'checked' : '') + '/>';
        }
        
        // Displei
        if (portSettings.pty != 255) {
            text += ', ' + _('Disp:') + ' <input class="tvalue" data-type="disp" type="text" style="width: 30px" data-port="' + index + '" value="' + (portSettings.disp || '') + '" maxsize="2"/>';
        }
        text += '</td>';
        
        text += '</tr>';
        return text;
    }

    //--------------------------------------------------------------------------------------------------
    function valueChanged() {
        var attr  = $(this).data('type');
        var index = $(this).data('port');

        if ($(this).attr('type') == 'checkbox') {
            ports[index][attr] = $(this).prop('checked');
        } else {
            ports[index][attr] = $(this).val();
        }

        ///if (attr == 'm' || attr == 'pty' || attr == 'd') {
        if (attr == 'm' || attr == 'pty' || (ports[index].pty == 3 && attr == 'd')) {
            // if input
            if (ports[index].pty == 0) {
                // m: 0 - on close, 1 - on change, 2 - on open
                if (ports[index].factor !== undefined) delete ports[index].factor;
                if (ports[index].offset !== undefined) delete ports[index].offset;
                if (ports[index].hst    !== undefined) delete ports[index].hst;
                if (ports[index].fr     !== undefined) delete ports[index].fr;
                if (ports[index].m2     !== undefined) delete ports[index].m2;
                if (ports[index].long   === undefined) ports[index].long   = true;
                if (ports[index].double === undefined) ports[index].double = true;

                if (ports[index].eth    === undefined) ports[index].eth = '';
                if (ports[index].ecmd   === undefined) ports[index].ecmd = '';
                if (ports[index].af     === undefined) ports[index].af = 0; // мое 0.7.0
                if (ports[index].naf    === undefined) ports[index].naf = 0;
                if (ports[index].d      === undefined) ports[index].d = 0;
                if (ports[index].misc   === undefined) ports[index].misc = 0;
                if (ports[index].m      === undefined) ports[index].m = 0;
                if (ports[index].m > 3) ports[index].m = 0;

                if (ports[index].m != 1) ports[index].long = false;
            } else
            if (ports[index].pty == 1) {
                if (ports[index].factor !== undefined) delete ports[index].factor;
                if (ports[index].offset !== undefined) delete ports[index].offset;
                if (ports[index].long   !== undefined) delete ports[index].long;
                if (ports[index].double !== undefined) delete ports[index].double;

                if (ports[index].eth    !== undefined) delete ports[index].eth;
                if (ports[index].ecmd   !== undefined) delete ports[index].ecmd;
                if (ports[index].naf    !== undefined) delete ports[index].naf;
                if (ports[index].d      === undefined) ports[index].d = 0;
                ///if (ports[index].misc   !== undefined) delete ports[index].misc;
                if (ports[index].m      === undefined) ports[index].m = 0;
                if (ports[index].m != 0) {
                    ports[index].misc = 0;
                    ports[index].m2   = 1;
                    ports[index].fr   = 0;
                } else {
                    if (ports[index].misc   !== undefined) delete ports[index].misc;
                    if (ports[index].m2     !== undefined) delete ports[index].m2;
                    if (ports[index].fr     !== undefined) delete ports[index].fr;
                }
                if (ports[index].m > 2) ports[index].m = 0;
            } else
            if (ports[index].pty == 2) {
                if (ports[index].factor === undefined) ports[index].factor = 1;
                if (ports[index].offset === undefined) ports[index].offset = 0;
                if (ports[index].long   !== undefined) delete ports[index].long;
                if (ports[index].double !== undefined) delete ports[index].double;

                if (ports[index].eth    === undefined) ports[index].eth  = '';
                if (ports[index].ecmd   === undefined) ports[index].ecmd = '';
                if (ports[index].d      !== undefined) delete ports[index].d;
                if (ports[index].misc   === undefined) ports[index].misc = 0;
                if (ports[index].m      === undefined) ports[index].m = 0;
            } else
            if (ports[index].pty == 3) {
                if (ports[index].factor !== undefined) delete ports[index].factor;
                if (ports[index].offset !== undefined) delete ports[index].offset;
                if (ports[index].long   !== undefined) delete ports[index].long;
                if (ports[index].double !== undefined) delete ports[index].double;

                if (ports[index].eth    === undefined) ports[index].eth  = '';
                if (ports[index].ecmd   === undefined) ports[index].ecmd = '';
                if (ports[index].d      === undefined) ports[index].d = 1;
                if (ports[index].d != 3) {
                    ports[index].misc = 0;
                    ports[index].m    = 0;
                    ports[index].hst  = 0;
                } else {
                    if (ports[index].misc   === undefined) ports[index].misc = 0;
                    if (ports[index].m      === undefined) ports[index].m = 0;
                    if (ports[index].hst    === undefined) ports[index].hst = 0;
                }
                if (ports[index].m > 3) ports[index].m = 0;
            } else
            if (ports[index].pty == 4) {
                if (ports[index].factor !== undefined) delete ports[index].factor;
                if (ports[index].offset !== undefined) delete ports[index].offset;
                if (ports[index].long   !== undefined) delete ports[index].long;
                if (ports[index].double !== undefined) delete ports[index].double;

                if (ports[index].eth    !== undefined) delete ports[index].eth;
                if (ports[index].ecmd   !== undefined) delete ports[index].ecmd;
                if (ports[index].naf    !== undefined) delete ports[index].naf;
                if (ports[index].m      === undefined) ports[index].m = 0;
                if (ports[index].misc   === undefined) ports[index].misc = 0;
                if (ports[index].d      === undefined) ports[index].d = 0;
            } else {
                if (ports[index].factor !== undefined) delete ports[index].factor;
                if (ports[index].offset !== undefined) delete ports[index].offset;
                if (ports[index].long   !== undefined) delete ports[index].long;
                if (ports[index].double !== undefined) delete ports[index].double;

                if (ports[index].eth    !== undefined) delete ports[index].eth;
                if (ports[index].ecmd   !== undefined) delete ports[index].ecmd;
                if (ports[index].d      !== undefined) delete ports[index].d;
                if (ports[index].misc   !== undefined) delete ports[index].misc;
                if (ports[index].m      !== undefined) delete ports[index].m;
                if (ports[index].hst    !== undefined) delete ports[index].hst;
                if (ports[index].fr     !== undefined) delete ports[index].fr;
                if (ports[index].m2     !== undefined) delete ports[index].m2;
            }

            showPorts();
        }
        onchange();
    }

    //----------------------------------------------------------------------------------------
    function onDelete() {
        var index = $(this).data('port');
        ports.splice(index, 1);
        onchange();
        showPorts();
    }

    //-----------------------------------------------------------------------------------------
    function onUp() {
        var index = $(this).data('port');
        var tmp = ports[index - 1];
        ports[index - 1] = ports[index];
        ports[index] = tmp;
        onchange();
        showPorts();
    }

    //-------------------------------------------------------------------------------------------
    function onDown() {
        var index = $(this).data('port');
        var tmp = ports[index + 1];
        ports[index + 1] = ports[index];
        ports[index] = tmp;
        onchange();
        showPorts();
    }

    //----------------------------------------------------------------------------------------
    function showPorts() {
/*
        var text = '<table class="tspace">';
        text += '<tr class="tspace ui-widget-header">';
        text += '<th class="tspace"></th>';
        // name, room, role, pty(type), ecmd(Action), eth(net action), m(mode), d(default state), pwm(0-255), misc (threshold)
        text += '<th class="tspace">' + _('Name') + '</th>';
        text += '<th class="tspace">' + _('Room') + '</th>';
        text += '<th class="tspace">' + _('Role') + '</th>';
        text += '<th class="tspace">' + _('Type') + '</th>';
        text += '<th class="tspace">' + _('Mode') + '</th>';
        text += '<th class="tspace"></th>';
        text += '<th class="tspace"></th>';
        text += '</tr>';

        for (var i = 0; i < ports.length; i++) {
            text += showOnePort(i, ports[i]);
        }
        text += '</table>';*/
        $('#ports').html(text);

        $('.tvalue').each(function () {
            if ($(this).attr('type') == 'text') {
                $(this).keyup(function () {
                    $(this).trigger('change');
                });
            }
            $(this).change(valueChanged);
        });

        $('.btn-delete').button({
            icons: {primary: 'ui-icon-trash'},
            text:  false
        }).css({width: 22, height: 22}).click(onDelete);
        $('.btn-up').button({
            icons: {primary: 'ui-icon-arrowthick-1-n'},
            text:  false
        }).css({width: 22, height: 22}).click(onUp);
        $('.btn-down').button({
            icons: {primary: 'ui-icon-arrowthick-1-s'},
            text:  false
        }).css({width: 22, height: 22}).click(onDown);

    }

    //-------------------------------------------------------------------------------
    function readRooms() {
        getEnums('rooms', function (err, _rooms) {
            rooms = _rooms;
            //showPorts();
        });
        getEnums('functions', function (err, _functions) {
            functions = _functions;
            //showPorts();
        });
    }

    //--------------------------------------------------------------------------------
    function setImage( imgName, newSrc ) {
       document.getElementById( imgName ).src = newSrc;
    }
    //--------------------------------------------------------------------------------
    function imagePorts( numXP ) {
       var spanId = "";
       var xp_sel = "#xp" + numXP + "model option:selected";
       var xp = "";
       var divId = "";
       var divClass = "";
       var startX = 0;
       var stepX = 0;
       var x = 0;
       var y1 = "";
       var y2 = "";
       var width = "";
       var labelId = "xp" + numXP + "model_label";
       var labelX  = "";
       var labelY  = "";
       var k = 0;
       var vUndef = 0;
       var minCycle = 0;
       var maxCycle = 14;
       var   y3 = "419px";
       var   x3 = 102;
       var portstate = "";

       if ( numXP == 0 ) {
          xp = "control";
       } else {
          xp = $(xp_sel).val();
       }

       if (xp == "7I7O-R" ) {
          stepX = 45;
          divClass = "sd7i7or";
          startX = 172;
          y1 = "228px";
          y2 = "306px";
          width = "17px";
          labelX = "164px";
          labelY = "15px";
       } else if (xp == "7I7O-SD") {
          stepX = 45;
          divClass = "sd7i7or";
          startX = 172;
          y1 = "236px";
          y2 = "315px";
          width = "17px";
          labelX = "164px";
          labelY = "15px";
       } else if (xp == "8I7O-S" || xp == "8I7O-SD") {
          stepX = 46;
          divClass = "sd7i7or";
          startX = 166;
          y1 = "241px";
          y2 = "321px";
          width = "17px";
          labelX = "164px";
          labelY = "15px";
          maxCycle = 15;
       } else if (xp == "14-IN") {
          stepX = 46;
          divClass = "sd7i7or";
          startX = 169;
          y1 = "235px";
          y2 = "316px";
          width = "17px";
          labelX = "535px";
          labelY = "7px";
       } else if (xp == "14-Rv1.0") {
          stepX = 37;
          divClass = "sd7i7or";
          startX = 194;
          y1 = "198px";
          y2 = "264px";
          width = "11px";
          labelX = "284px";
          labelY = "11px";
       } else if (xp == "14-Rv2.0") {
          stepX = 37;
          divClass = "sd7i7or";
          startX = 194;
          y1 = "198px";
          y2 = "264px";
          width = "11px";
          labelX = "284px";
          labelY = "11px";
          maxCycle = 15;
          x3 = 244;
          y3 = "318px";
       } else if (xp == "2R") {
          stepX = 37;
          divClass = "sd7i7or";
          startX = 72;
          y1 = "223px";
          y2 = "264px";
          width = "11px";
          labelX = "284px";
          labelY = "11px";
          maxCycle = 2;
       } else if (xp == "control") {
          stepX = 32;
          divClass = "xt2_port";
          startX = 461;
          y1 = "200px";
          y2 = "204px";
          width = "30px";
          labelX = "284px";
          labelY = "11px";
          minCycle = 30;
          maxCycle = 38;
       }  
       x = startX;

       document.getElementById( labelId ).style.left = labelX;
       document.getElementById( labelId ).style.top  = labelY;

       for (var m = minCycle; m < maxCycle; m++) {
          spanId = "span_xp" + numXP + "_p" + m;
          divId  = "div_xp"  + numXP + "_p" + m;

          if ( numXP == 1 ) {
             k = m;
          } else if ( numXP == 2 ) {
             k = m + 15;
          } else if ( numXP == 0 ) {
             k = m + 30;
          }

          document.getElementById( divId ).className   = divClass;
          document.getElementById( divId ).style.width = width;
          if ( numXP != 0 ) {
             if ( m < 7 ) {
                document.getElementById( divId ).style.top = y1;
             } else if ( m == 14 ) {
                document.getElementById( divId ).style.top = y3;
             } else {
                document.getElementById( divId ).style.top = y2;
             }
             if ( m == 0 || m == 7 ) {
                x = startX;
             } else if ( m == 14 ) {
                x = x3;
             } else if ( xp == "14-IN" ) { // сдвиг для корректного накладывания
                if ( m ==2 || m == 3 || m == 9 || m == 10 ) {
                   x = x - 1;
                }
             }
             document.getElementById( divId ).style.left = x + "px";
             x = x + stepX;
          } else {
             if ( m === 30 ) {
                document.getElementById( divId ).style.left = "461px";
                document.getElementById( divId ).style.top  = "200px";
                document.getElementById( divId ).style.height  = "85px";
             } else if ( m === 31 ) {
                document.getElementById( divId ).style.left    = "493px";
                document.getElementById( divId ).style.top     = "200px";
                document.getElementById( divId ).style.height  = "104px";
             } else if ( m === 32 ) {
                document.getElementById( divId ).style.left    = "506px";
                document.getElementById( divId ).style.top     = "173px";
                document.getElementById( divId ).style.height  = "104px";
             } else if ( m === 33 ) {
                document.getElementById( divId ).style.left    = "538px";
                document.getElementById( divId ).style.top     = "200px";
                document.getElementById( divId ).style.height  = "104px";
             } else if ( m === 34 ) {
                document.getElementById( divId ).style.left    = "552px";
                document.getElementById( divId ).style.top     = "173px";
                document.getElementById( divId ).style.height  = "104px";
             } else if ( m === 35 ) {
                document.getElementById( divId ).style.left    = "583px";
                document.getElementById( divId ).style.top     = "200px";
                document.getElementById( divId ).style.height  = "85px";
             } else if ( m === 36 ) {
                document.getElementById( divId ).style.width   = "94px";
                document.getElementById( divId ).style.left    = "400px";
                document.getElementById( divId ).style.top     = "100px";
                document.getElementById( divId ).style.height  = "85px";
             } else if ( m === 37 ) {
                document.getElementById( divId ).style.width   = "94px";
                document.getElementById( divId ).style.left    = "524px";
                document.getElementById( divId ).style.top     = "100px";
                document.getElementById( divId ).style.height  = "69px";
             }
          }

          portstate = $('#portState' + k ).val();

          if (xp == "7I7O-R" || xp == "7I7O-SD") {
             if ( m < 7 ) {
                if ( portstate == cPortType_NotConnected ) {
                   document.getElementById( spanId ).className = "circlebutton_darkgreen";
                } else {
                   document.getElementById( spanId ).className = "circlebutton_green";
                }
             } else {
                if ( portstate == cPortType_NotConnected ) {
                   document.getElementById( spanId ).className = "circlebutton_darkred";
                } else {
                   document.getElementById( spanId ).className = "circlebutton_red";
                }
             }
          } else if ((xp == "8I7O-S") || (xp == "8I7O-SD")) {
             if ( m < 7 || m == 14 ) {
                if ( portstate == cPortType_NotConnected ) {
                   document.getElementById( spanId ).className = "circlebutton_darkgreen";
                } else {
                   document.getElementById( spanId ).className = "circlebutton_green";
                }
             } else {
                if ( portstate == cPortType_NotConnected ) {
                   document.getElementById( spanId ).className = "circlebutton_darkred";
                } else {
                   document.getElementById( spanId ).className = "circlebutton_red";
                }
             }
          } else if (xp == "14-IN") {  
             if ( portstate == cPortType_NotConnected ) {
                 document.getElementById( spanId ).className = "circlebutton_darkgreen";
             } else {
                 document.getElementById( spanId ).className = "circlebutton_green";
             }
          } else if (xp == "14-Rv1.0") {
             if ( portstate == cPortType_NotConnected ) {
                 document.getElementById( spanId ).className = "circlebutton_darkred";
             } else {
                 document.getElementById( spanId ).className = "circlebutton_red";
             }
          } else if (xp == "14-Rv2.0") {
             if ( m < 14 ) {
                if ( portstate == cPortType_NotConnected ) {
                   document.getElementById( spanId ).className = "circlebutton_darkred";
                } else {
                   document.getElementById( spanId ).className = "circlebutton_red";
                }
             } else {
                if ( portstate == cPortType_NotConnected ) {
                   document.getElementById( spanId ).className = "circlebutton_darkgreen";
                } else {
                   document.getElementById( spanId ).className = "circlebutton_green";
                }
             }
          } else if (xp == "2R") {
             if ( portstate == cPortType_NotConnected ) {
                 document.getElementById( spanId ).className = "circlebutton_darkred";
             } else {
                 document.getElementById( spanId ).className = "circlebutton_red";
             }
          } else if (xp == "control") {
             document.getElementById( spanId ).className = "xt2_port";
          };

       }
    }
    //--------------------------------------------------------------------------------
    function roomChanged ( controlPort ) {
        //var room = $("#ports."+controlPort+".room option:selected").val();
        var numXP = 0;
        if ( controlPort < 15 ) {
           numXP = 1;
        } else if ( controlPort < 30 ) {
           numXP = 2;
        } else {
           numXP = 0;
        }
        var room = $('#roomXP'+numXP+' option:selected').val();
        $('#roomXP'+numXP).val(room);

        //ports[controlPort].room = room;
    }
    //--------------------------------------------------------------------------------
    function nameChanged ( controlPort ) {
        var name = $("#name"+controlPort+" option:selected").val();
        ports[controlPort].name = name;
        ports[controlPort].desc = name;
    }
    //--------------------------------------------------------------------------------
    function fncChanged ( controlPort ) {
        var numXP = 0;
        if ( controlPort < 15 ) {
           numXP = 1;
        } else if ( controlPort < 30 ) {
           numXP = 2;
        } else {
           numXP = 0;
        }
        var fnc = $('#fncXP'+numXP+' option:selected').val();
        $('#fncXP'+numXP).val(fnc);
    }

    //--------------------------------------------------------------------------------
    function ptyChanged ( controlPort ) {
        var numXP;
        var port;
        if ( controlPort < 15 ) {
           numXP = 1;
           port  = controlPort;
        } else if ( controlPort < 30 ) {
           numXP = 2;
           port = controlPort - 15;
        } else {
           numXP = 0;
           port = controlPort;
        }

        var pty = $('#portTypeXP'+numXP+' option:selected').val();
        $('#portTypeXP'+numXP).val(pty);
        $('#portState' + controlPort ).val(pty);
        //portState[ controlPort ] = pty;


        loadPresetSub( numXP, port ); // при изменении типа порта перерисовываем его описание
    }
    //--------------------------------------------------------------------------------
    function mChanged ( controlPort ) {
        var m = $("#m"+controlPort+" option:selected").val();
        ports[controlPort].m = m;
        if ( ports[controlPort].m == 3 ) {
           // для Mode = click mode отключаем флажок
           ports[controlPort].misc = 0;
           //document.getElementById( "misc" + controlPort ).checked = "false";
           $("#misc"+controlPort).removeAttr("checked");
           document.getElementById( "misc" + controlPort ).style.visibility = "hidden";
           document.getElementById( "lblmisc" + controlPort ).style.visibility = "hidden";
        } else {
           document.getElementById( "misc" + controlPort ).style.visibility = "visible";
           document.getElementById( "lblmisc" + controlPort ).style.visibility = "visible";
        }
    }
    //--------------------------------------------------------------------------------
    function dChanged ( controlPort ) {
        var d = $("#d"+controlPort+" option:selected").val();
        ports[controlPort].d = d;
    }
    //--------------------------------------------------------------------------------
    function ecmdChanged ( controlPort ) {
        var numXP = 0;
        if ( controlPort < 15 ) {
           numXP = 1;
        } else if ( controlPort < 30 ) {
           numXP = 2;
        } else {
           numXP = 0;
        }

        var ecmd = $("#ecmdXP"+numXP).val();
    }
    //--------------------------------------------------------------------------------
    function dispChanged ( controlPort ) {
        var disp = $("#disp"+controlPort).val();
        ports[controlPort].disp = disp;
    }
    //--------------------------------------------------------------------------------
    function ethChanged ( controlPort ) {
        var eth = $("#eth"+controlPort).val();
        ports[controlPort].eth = eth;
    }
    //--------------------------------------------------------------------------------
    function NafChanged ( controlPort ) {
        var text = "";
        if ( $("#naf"+controlPort ).prop('checked') ) {
           ports[controlPort].naf = 1;
           text = 'Вызывать ТОЛЬКО при недоступности сервера';
        } else {
           ports[controlPort].naf = 0;
           text = 'Выполнять всегда';
        }
        document.getElementById( "lblnaf" + controlPort ).innerHTML = text;
    }
    //--------------------------------------------------------------------------------
    function afChanged ( controlPort ) {
        var text = "";
        var numXP = 0;
        if ( controlPort < 15 ) {
           numXP = 1;
        } else if ( controlPort < 30 ) {
           numXP = 2;
        } else {
           numXP = 0;
        }

        if ( $("#afXP"+numXP ).prop('checked') ) {
           //ports[controlPort].af = 1;
           $('#afXP'+numXP ).val( 1 );
           text = 'Выполнять всегда, независимо от наличия сервера';
        } else {
           //ports[controlPort].af = 0;
           $('#afXP'+numXP ).val( 0 );
           text = 'Выполнять только если сервер не прописан или недоступен';
        }
        document.getElementById( "lblAfXP" + numXP ).innerHTML = text;
    }
    //--------------------------------------------------------------------------------
    function dChanged ( controlPort ) {
        var text = "";
        if ( $("#d"+controlPort ).prop('checked') ) {
           ports[controlPort].d = 1;
           text = 'Включено по умолчанию';
        } else {
           ports[controlPort].d = 0;
           text = 'Выключено по умолчанию';
        }
        document.getElementById( "lbl" + controlPort ).innerHTML = text; //?lbl
    }
    //--------------------------------------------------------------------------------
    function MiscChanged ( controlPort ) {
        var text = "";
        if ( $("#misc"+controlPort ).prop('checked') ) {
           ports[controlPort].misc = 1;
           text = 'Отправлять на сервер всегда в режиме P&amp;R';
        } else {
           ports[controlPort].misc = 0;
           text = 'Отправлять на сервер в режиме, установленном в Mode';
        }
        document.getElementById( "lblmisc" + controlPort ).innerHTML = text;
    }
    //--------------------------------------------------------------------------------
    function RawChanged ( controlPort ) {
        var text = "";
        if ( $("#d"+controlPort ).prop('checked') ) {
           ports[controlPort].d = 1;
           text = 'Защита от дребезга отключена';
        } else {
           ports[controlPort].d = 0;
           text = 'Защита от дребезга включена';
        }
        document.getElementById( "lbld" + controlPort ).innerHTML = text; //?lbl
    }
    // -------------------------------------------------------------------------------
    function loadPreset( numXP, portNum ) {
       // здесь считываются настройки конкретного порта из конфига сервера (не МЕГИ)
       var controlPort = portNum;

       if (numXP == 2) {
           controlPort = 15 + portNum;
       }

       socket.emit('getState',  adapter + '.' + instance + '.ports.' + controlPort + '.room', function (err, state) {
          if (state) {
             $("#roomXP"+numXP).val( state.val );
             onchange();
          }
          socket.emit('getState',  adapter + '.' + instance + '.ports.' + controlPort + '.func', function (err, state) {
             if (state) {
                 $("#fncXP"+numXP).val( state.val );
                 onchange();
             }
          });
       });

       socket.emit('getState',  adapter + '.' + instance + '.ports.' + controlPort + '.portType', function (err, state) {
          if (state) {
              $("#portTypeXP"+numXP).val( state.val );
              $('#portTypeXP'+numXP+' option:selected').val(state.val);
              $('#portTypeXP'+numXP+' select').val(state.val);
              //$('#portState' + controlPort ).val(state.val);
              //portState[ controlPort ] = state.val;

              $('#portTypeXP'+numXP+' option').each(function() {
                   if($(this).val() == state.val) {
                         $(this).prop("selected", true);
                   }
              });
              ptyChanged( controlPort ); // ?
          //} else {
          //    $('#portState' + controlPort ).val( cPortType_NotConnected );
          //    ptyChanged( controlPort ); // ?
              //portState[ controlPort ] = cPortType_NotConnected;
          }
       });

       socket.emit('getState',  adapter + '.' + instance + '.ports.' + controlPort + '.defaultAction', function (err, state) {
          if (state) {
              $("#ecmdXP"+numXP).val( state.val );
              onchange();
          }
       });

       socket.emit('getState',  adapter + '.' + instance + '.ports.' + controlPort + '.defaultRunAlways', function (err, state) {
          if (state) {
              if ( state.val == true || state.val == 'true') {
                 $('#afXP' + numXP ).prop('checked', true);
                 $("#afXP" + numXP ).val( 1 );
              } else {
                 $('#afXP' + numXP ).removeAttr('checked');
                 $("#afXP"+numXP).val( 0 );
              }
              afChanged( controlPort );
          }
       });

      loadPresetSub( numXP, portNum );

    }
    //--------------------------------------------------------------------------------
    function loadPresetSub( numXP, portNum ) {
        var xp = "";
        var text = "";
        var controlPort = portNum;
        var spanAct0 = "";
        var spanAf0  = "";
        var spanEth0 = "";
        var spanNaf0 = "";
        var spanPorts = "";
        var spanDef = "";
        var spanM = "";
        var spanMisc = "";
        var spanDisp = '';

        if (numXP == 2) {
           controlPort = 15 + portNum;
        }

        if ( numXP > 0 ) {
           xp = $("#xp"+numXP+"model option:selected").val();

//           text += '<br>Комната: <select id="ports.'+controlPort+'.room" onChange="roomChanged('+controlPort+');">';
//           text += '<input type="hidden" id="old_room" value="'+portSetup.room+'">';
//           text += '<input type="hidden" id="old_fnc" value="'+portSetup.func+'">';
//           text += '<input type="hidden" id="old_portType" value="'+portSetup.portType+'">';

/*           for ( var i = 0; i <= 37; i++ ) {
               text += '<br>DEBUG:<br>';
//               text += i + ' - ' + portState[ i ] + '<br>';
               text += i + ' - ' + $('#portState'+i).val() + '<br>';
               text += '---------------------<br>';
           }*/

           text += '<br>Комната: <select id="roomXP'+numXP+'" onChange="roomChanged('+controlPort+');">';
           text += '<option value=""></option>';
           for (var r in rooms) {
//               text += '<option value="' + r + '" ' + ((ports[controlPort].room == r) ? 'selected' : '') + '>' + rooms[r].common.name + '</option>';
               text += '<option value="' + r + '" ' + (($('#roomXP'+numXP).val() == r) ? 'selected' : '') + '>' + rooms[r].common.name + '</option>';
           }
           text += '</select><br>';

           text += '<br>Функция: <select id="fncXP'+numXP+'" onChange="fncChanged('+controlPort+');">';
           text += '<option value=""></option>';
           for (var r in functions) {
               text += '<option value="' + r + '" ' + (($('#fncXP'+numXP).val() == r) ? 'selected' : '') + '>' + functions[r].common.name + '</option>';
           }
           text += '</select><br>';
  

/*           text += '<br>Название: <input id="name'+controlPort+'" onChange="nameChanged('+controlPort+');" ';
           text += ' value="' + ports[controlPort].name + '"></input><br>';
  */

        } else {
           xp = 'control';
        }


        spanPorts  = '<div class="htooltip"><img src="img/emblem-notice.png" width="20px" height="20px"></img>';
        spanPorts += '<span><p align=justify>';
        spanPorts += '<b>"Стандартный вход"</b> - порт с опторазвязкой, защищающей контроллер от внешних факторов, ';
        spanPorts += 'который предназначен для подключения: кнопок, выключателей, герконов, датчиков протечки, ';
        spanPorts += 'охранных извещателей, датчиков напряжения и других датчиков, которые работают ';
        spanPorts += 'по принципу ВКЛ/ВЫКЛ. Этот порт не предназначен для подключения цифровых датчиков ';
        spanPorts += 'и устройств, аналоговых датчиков, для которых требуется измерение выходного напряжения.</p><p align=justify>';
        spanPorts += '<b>"Релейный выход"</b> - порт, где в качестве коммутирующего цепь элемента используется ';
        spanPorts += 'механическое реле. Этот порт предназначен для управления любыми приборами ';
        spanPorts += 'в диапазоне напряжений от 0 до 250В. Реле может коммутировать как постоянный, ';
        spanPorts += 'так и переменный ток. Максимальный ток (мощность) указан в документации к исполнительным ';
        spanPorts += 'модулям и находится в диапазоне от 6А до 10А (2300Вт) для переменного тока и активной нагрузки. ';
        spanPorts += 'К минусам реле можно отнести наличие звука при замыкании и размыкании контактов (щелчки), ';
        spanPorts += 'которые характерны для механических реле любого типа. В случае, если в цепи используются ';
        spanPorts += 'защитные автоматы, реле относительно хорошо переносят кратковременные короткие замыкания.</p><p align=justify>';
        spanPorts += '<b>"Симисторный выход"</b> - порт, где в качестве коммутирующего цепь элемента используется ';
        spanPorts += 'полупроводниковый прибор симистор. Этот порт предназначен для управления любыми приборами, ';
        spanPorts += 'работающими от сети 220В переменного тока. Обратите внимание, что с помощью симисторов ';
        spanPorts += 'нельзя управлять, скажем, электромеханическими замками с напряжением 12В или приборами, ';
        spanPorts += 'работающими от постоянного тока. Симисторы могут коммутировать только переменный ток ';
        spanPorts += 'с напряжением выше 170В. В отличие от реле, симисторы абсолютно бесшумны. ';
        spanPorts += 'К минусам симисторов можно отнести неспособность переносить короткие замыкания. ';
        spanPorts += 'КЗ в управляемой цепи приводит к выходу симистора из строя и необходимости его замены.</p><p align=justify>';
        spanPorts += '<b>"Цифровой вход"</b> - порт с подтягивающим резистором 4,7кОм предназначен для подключения ';
        spanPorts += 'любых цифровых датчиков и устройств, а также (в случае наличия данной функции у порта) ';
        spanPorts += 'позволяет подключать аналоговые датчики.</p>';
        spanPorts += '</span></div>';


//        text += 'Тип порта: <select id="pty'+controlPort+'" class="tvalue" data-type="pty" data-port="' + controlPort + '" onChange="ptyChanged('+controlPort+');">';
        text += '<table border="0" class="tablemore"><tr><td align="center" valign="middle">'; // описания портов
        text += spanPorts + '</td><td align="left" valign="middle">';
        text += 'Тип порта:&nbsp;';
        //text += '</td><td align="left" valign="middle">';

                //--- выбор типа порта ---------------------------------------------------------------------
        text += '<select id="portTypeXP'+numXP+'" onChange="ptyChanged('+controlPort+');">';
        text += '<option value="'+cPortType_NotConnected+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_NotConnected) ? 'selected' : '') + '>' + _('NC')  + '</option>';
        if ( xp == '7I7O-R' || xp == '7I7O-SD' ) {
           if (portNum < 7) {
              text += '<option value="'+cPortType_StandartIn+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_StandartIn)   ? 'selected' : '') + '>Стандартный вход (In)</option>';
           } else {
              if ( xp == '7I7O-R' ) {
                 text += '<option value="'+cPortType_ReleOut+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_ReleOut)   ? 'selected' : '') + '>Релейный выход</option>';
              } else {
                 if ( portNum == 10 || portNum == 12 || portNum == 13 ) {
                     text += '<option value="'+cPortType_DimmedOut+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_DimmedOut)   ? 'selected' : '') + '>Симисторный диммируемый выход</option>';
                 } else {
                     text += '<option value="'+cPortType_SimistorOut+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_SimistorOut)   ? 'selected' : '') + '>Симисторный недиммируемый выход</option>';
                 }
              }
           }
        } else if ( xp == '8I7O-S' ) {
           if (portNum < 7) {
              text += '<option value="'+cPortType_StandartIn+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_StandartIn)   ? 'selected' : '') + '>Стандартный вход (In)</option>';
           } else if (portNum < 14) {
              text += '<option value="'+cPortType_SimistorOut+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_SimistorOut)   ? 'selected' : '') + '>Симисторный недиммируемый выход</option>';
           } else {
              text += '<option value="'+cPortType_DigitalSensor+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_DigitalSensor)   ? 'selected' : '') + '>Цифровой вход (DSen)</option>';
           }
        } else if ( xp == '8I7O-SD' ) {
           if (portNum < 7) {
              text += '<option value="'+cPortType_StandartIn+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_StandartIn)   ? 'selected' : '') + '>Стандартный вход (In)</option>';
           } else if ( portNum == 10 || portNum == 12 || portNum == 13 ) { /// ?????
              text += '<option value="'+cPortType_DimmedOut+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_DimmedOut)   ? 'selected' : '') + '>Симисторный диммируемый выход</option>';
           } else if (portNum < 14) {
              text += '<option value="'+cPortType_SimistorOut+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_SimistorOut)   ? 'selected' : '') + '>Симисторный недиммируемый выход</option>';
           } else {
              text += '<option value="'+cPortType_DigitalSensor+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_DigitalSensor)   ? 'selected' : '') + '>Цифровой вход (DSen)</option>';
           }
        } else if ( xp == '14-IN' ) {
           text += '<option value="'+cPortType_StandartIn+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_StandartIn)   ? 'selected' : '') + '>Стандартный вход (In)</option>';
           text += '<option value="'+cPortType_DigitalSensor+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_DigitalSensor)   ? 'selected' : '') + '>Цифровой вход (DSen)</option>';
           text += '<option value="'+cPortType_I2C+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_I2C)   ? 'selected' : '') + '>Вход I2C</option>';
           if ( portNum <= 5 ) {
              text += '<option value="'+cPortType_AnalogSensor+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_AnalogSensor)   ? 'selected' : '') + '>АЦП-вход для аналоговых датчиков</option>';
           }
        } else if ( xp == '14-Rv1.0' ) {
           if (portNum < 14) {
              text += '<option value="'+cPortType_ReleOut+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_ReleOut)   ? 'selected' : '') + '>Релейный выход</option>';
           } /*else {
              text += '<option value="3" ' + ((ports[controlPort].pty == 3)   ? 'selected' : '') + '>Цифровой вход (DSen)</option>';
           }   */
        } else if ( xp == '14-Rv2.0' ) {
           if (portNum < 14) {
              text += '<option value="'+cPortType_ReleOut+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_ReleOut)   ? 'selected' : '') + '>Релейный выход</option>';
           } else {
              text += '<option value="'+cPortType_DigitalSensor+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_DigitalSensor)   ? 'selected' : '') + '>Цифровой вход (DSen)</option>';
           }
        } else if ( xp == '2R' ) {
           if (portNum < 2) {
              text += '<option value="'+cPortType_ReleOut+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_ReleOut)   ? 'selected' : '') + '>Релейный выход</option>';
           } /*else {
              text += '<option value="3" ' + ((ports[controlPort].pty == 3)   ? 'selected' : '') + '>Цифровой вход (DSen)</option>';
           }   */
        } else if ( xp == 'control' ) {
           if ( portNum < 36 ) {
              text += '<option value="'+cPortType_DigitalSensor+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_DigitalSensor)   ? 'selected' : '') + '>Цифровой вход (DSen)</option>';
              text += '<option value="'+cPortType_I2C+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_I2C)   ? 'selected' : '') + '>Вход I2C</option>';
           } else {
              text += '<option value="'+cPortType_AnalogSensor+'" ' + (($('#portTypeXP'+numXP).val() == cPortType_AnalogSensor)   ? 'selected' : '') + '>АЦП-вход для аналоговых датчиков</option>';
           }
        }
        text += '</select>';
        text += '</td></tr>';

        //-----------------------------------------------------------------------------
        // порт IN
        if ( $('#portTypeXP'+numXP).val() == cPortType_StandartIn ) {
           spanAct0  = '<div class="htooltip"><img src="img/emblem-notice.png" width="20px" height="20px"></img><span>';
           spanAct0 += '<p align=justify><b>Act</b> - Действие, которое необходимо произвести, в случае, когда сервер не указан, не отвечает или HTTP-статус ответа отличный от "200 OK".</p>';
           spanAct0 += '<p align=justify>Контроллер MegaD-2561, по своей сути, является исполнителем указаний центральной управляющей ';
           spanAct0 += 'системы (сервера). В таком режиме в сетевых настройках конфигурируется IP-адрес сервера. При каждом нажатии на ';
           spanAct0 += 'кнопку, устройство вызывает скрипт на сервере, в параметрах вызова которого указывается номер сработавшего входа. ';
           spanAct0 += 'Выглядит запрос примерно следующим образом:</p>';
           spanAct0 += '<p align=left><b><i>http://192.168.0.250/megad.php?pt=2</i></b></p>';
           spanAct0 += '<p align=justify>В ответ сервер дает указания, команду на переключение выходов. Подробнее о программировании ';
           spanAct0 += 'скрипта на сервере описано ниже.</p>';
           spanAct0 += '<p align=justify>Но в случае, если сервер не прописан в конфигурации или прописан, но не отвечает (или отвечает статусом, отличным от HTTP 200), тогда срабатывает Action ';
           spanAct0 += '"сценарий по умолчанию". Тогда устройство самостоятельно переключает нужные выходы в соответствии с  прописанным ';
           spanAct0 += 'сценарием. Например, если MegaD-2561 подключен к системе для управления освещением, то пользователь не останется ';
           spanAct0 += 'без света, даже когда сервер будет отключен. При работающем сервере команды будет давать он, при неработающем ';
           spanAct0 += 'MegaD-2561 сам будет включать лампочки согласно тому алгоритму, который записан в поле Action.</p>';
           spanAct0 += '<p align=justify>Формат поля Action следующий: <b>X:Y;X:Y;X:Y</b><br>';
           spanAct0 += 'где: X - <b>номер порта</b>, а Y - <b>действие</b><br>';
           spanAct0 += '0 - <b>выключить</b>;<br>';
           spanAct0 += '1 - <b>включить</b>;<br>';
           spanAct0 += '2 - <b>изменить состояние на противоположное (переключить)</b>, т.е. если было включено - выключить, и наоборот</p>';
           spanAct0 += '<p align=justify><i>Номер порта, двоеточие, действие</i>. Таких действий может быть несколько и тогда они разделяются точкой с запятой.';
           spanAct0 += '"10:2" означает, что необходимо состояние порта P10 изменить на противоположное.';
           spanAct0 += 'В поле Action через точку с запятой можно описать до пяти действий.</p>';
           spanAct0 += '<p align=justify>В сценариях контроллер поддерживает паузы. Например: 7:1;p10;7:0 (включить выход 7, подождать 1 секунду [единица 0,1с], выключить выход 7).';
           spanAct0 += '<b>Важно</b>: паузы работают только в сценариях по умолчанию (Action) и не работают в ответах и командах с сервера! Если используется сервер, он может самостоятельно выдерживать любые паузы.</p>';
           spanAct0 += '<p align=justify>Команда <b>"a". Управление всеми выходами</b>. Например: a:0 (выключить все выходы), a:1 (включить все выходы).</p>';
           spanAct0 += '<p align=justify>Синхронизация входа и выхода. Команды <b>3</b> и <b>4</b>. Если вход сконфигурирован как P&R (читайте об этом ниже), ';
           spanAct0 += 'то команда <b>3</b> - состояние выхода <b>соответствует состоянию входа</b>, команда <b>4</b> - состояние выхода <b>противоположно состоянию входа</b>.</p>';
           spanAct0 += '<p align=justify>Простейший пример синхронизации входа и выхода. Работа кнопки звонка. При нажатии на кнопку, которая подключена на вход, включается выход, к которому подключен звонок. ';
           spanAct0 += 'При отпускании кнопки, звонок выключается.</p>';
           spanAct0 += '<p align=justify><b>Работа с ШИМ портами</b>. Если выход сконфигурирован как ШИМ, то вместо команды указывается конкретное значение от 0 до 255. Например: <i>10:200</i>.<br>';
           spanAct0 += 'Контроллер поддерживает <b>команду переключения для ШИМ-порта</b>, которая аналогична команде "2". Для этого используется модификатор *. Например: <i>10:*200</i><br>';
           spanAct0 += 'Эта команда означает, что при первом нажатии кнопки, значение порта ШИМ будет установлено 200, а при повторном 0.</p>';
           spanAct0 += '<b>Команды для управления диммируемыми каналами: +, -, ~</b><br>';
           spanAct0 += '<p align=justify>Например, требуется управлять яркостью освещения двумя кнопками. Одна кнопка будет увеличивать яркость, а другая уменьшать.';
           spanAct0 += 'Для одной кнопки необходимо прописать Сценарий: <b>10:+</b><br>';
           spanAct0 += 'Для второй кнопки необходимо прописать Сценарий: <b>10:-</b><br>';
           spanAct0 += 'Тогда однократное нажатие на кнопку прибавления включает свет на ту величину, на которую свет был включен предыдущий раз. ';
           spanAct0 += 'Соответственно, однократное нажатие на кнопку убавления - выключает свет. Нажатие и удержание кнопок плавно увеличивает или уменьшает яркость. ';
           spanAct0 += 'Но если требуется обойтись только одной кнопкой, то тогда в сценарии необходимо прописать так: <b>10:~</b><br>';
           spanAct0 += 'Работает управление аналогичным образом. Однократное нажатие включает или выключает нагрузку. Удержание изменяет яркость в ту или другую сторону.</p>';
           spanAct0 += '<p align="center"><b>Команды для управления диммируемыми каналами: ^, v, x</b></p>';
           spanAct0 += '<p align="justify">Команды "+", "-" и "~", описанные ранее, работают только в режиме удержания кнопки и только в автономном режиме, то есть будучи прописанными в поле Act. ';
           spanAct0 += 'Но что, если необходимо управлять процессом диммирования с помощью сервера?</p>';
           spanAct0 += 'Плавно менять яркость с помощью сервера можно тремя способами.<br>';
           spanAct0 += '1. С помощью отправки серии пакетов с запросом в виде <b>cmd=yy:xxx</b>, где <b>yy</b> - номер порта, а <b>xxx</b> - значение ШИМ (PWM).<br>';
           spanAct0 += '2. С использованием опции <b>smooth</b>, с помощью которой можно было отправить только один пакет с заданной яркостью (например, <b>cmd=12:255</b>), а контроллер самостоятельно увеличивал/уменьшал яркость в зависимости от заданного в этой опции значения скорости.<br>';
           spanAct0 += '3. С помощью новых команд <b>"^", "v", "x"</b><br>';
           spanAct0 += 'Команда "^" запускает процесс увеличения яркости. Например: 12:^<br>';
           spanAct0 += 'Команда "v" запускает процесс уменьшения яркости. Например: 12:v<br>';
           spanAct0 += 'Команда "x" останавливает ранее запущенный процесс изменения яркости. Например: 12:x</p>';
           spanAct0 += '<p align="justify">В отличие от "+-~" эти команды может использовать сервер.<br>';
           spanAct0 += 'Таким образом, сервер не задает конечное значение яркости, а запускает процесс изменения. Эти же команды можно использовать в сценариях. Причем, в отличие от "+-~", новые команды можно комбинировать с другими. Например: 12:^;7:2</p>';
           spanAct0 += '<p align="justify">Но и это еще не все. В этой же команде можно передавать скорость изменения яркости от 1 до 9. Пример: 12:^2 (чем меньше цифра, тем быстрее происходит изменение. По умолчанию: 5). ';
           spanAct0 += 'Для того, чтобы остановить процесс изменения яркости, достаточно снова выполнить одну из команд "^" или "v".</p>';
           spanAct0 += '<p align="justify">Эти команды расширяют возможности сервера для управления диммируемыми каналами.<br>';
           spanAct0 += 'В автономном режиме (без сервера) эти команды можно использовать с двумя кнопками, когда нажатие на одну кнопку будет изменять яркость в одну сторону (без необходимости удержания), а нажатие на вторую кнопку в другую сторону.</p>';
           spanAct0 += '<p align=justify><b>Важно!</b> После срабатывания входа MegaD-2561, если прописан сервер, пытается в течение <b>примерно 2 секунд</b> связаться с ним.';
           spanAct0 += ' В случае неудачи, выполняется сценарий, описанный в поле Action. Также этот сценарий выполняется сразу, если сервер в сетевых настройках не прописан.';
           spanAct0 += '<p align=justify><b>Дополнительная команда "d" (default).</b> Если сервер на факт срабатывания входа, возвращает "d", то это дает сигнал устройству выполнить сценарий по умолчанию (Act). ';
           spanAct0 += 'Эта команда дублирует поведение контроллера в случае установленного флажка Act, но в этом случае <b>сам сервер определяет</b>, когда выполнять сценарий по умолчанию.';
           spanAct0 += 'Таким образом, можно использовать сервер вместе, в частности, с командами управления диммируемыми выходами. Достаточно серверу при срабатывании нужных входов вернуть устройству "d", и он обработает все операции с клавишами выключателя. ';
           spanAct0 += 'Но серверу интересно было бы знать значение ШИМ, которое получилось на выходе. Это просто. Устройство ведь может сообщать о факте отжатия клавиши (m=1). Серверу необходимо лишь опросить состояние нужного выхода при получении сигнала об отжатии клавиши. Все остальное контроллер сделает сам.</p>';
           spanAct0 += '</span></div>';

           spanAf0   = '<div class="htooltip"><img src="img/emblem-notice.png" width="20px" height="20px"></img><span>';
           spanAf0  += '<p align=justify>Этот флажок определяет логику работы сценария. Если он <b>не установлен</b> (по умолчанию), то сценарий выполняется ТОЛЬКО если сервер не прописан или недоступен. ';
           spanAf0  += 'Если флажок <b>установлен</b>, то сценарий выполняется всегда, независимо от наличия сервера. Контроллер в этом случае будет сообщать на сервер о событиях, но его ответные команды в рамках одной TCP-сессии будут проигнорированы.</p>';
           spanAf0  += '<p align=justify><b>Дополнительная команда "d"</b> (default). Если сервер на факт срабатывания входа, возвращает "d", то это дает сигнал устройству выполнить сценарий по умолчанию (Act). ';
           spanAf0  += 'Эта команда дублирует поведение контроллера в случае установленного флажка, но в этом случае сам сервер определяетб когда выполнять сценарий по умолчанию. ';
           spanAf0  += 'Таким образом, можно использовать сервер вместе, в частности, с командами управления диммируемыми выходами. Достаточно серверу при срабатывании нужных входов вернуть устройству "d", и он обработает все операции с клавишами выключателя. ';
           spanAf0  += 'Но серверу интересно было бы знать значение ШИМ, которое получилось на выходе. Это просто. Устройство ведь может сообщать о факте отжатия клавиши (m=1). Серверу необходимо лишь опросить состояние нужного выхода при получении сигнала об отжатии клавиши. Все остальное контроллер сделает сам.</p>';
           spanAf0  += '</span></div>';

           spanEth0  = '<div class="htooltip"><img src="img/emblem-notice.png" width="20px" height="20px"></img><span>';
           spanEth0 += '<p align=justify><b>NetAction (Net)</b> - В этом поле записывается URL, который MegaD-2561 вызывает независимо от того, есть сервер или его нет. Этот URL вызывается после попытки связи с сервером и после того, как отработает сценарий, описанный в поле Action. ';
           spanEth0 += 'После IP-адреса можно указать порт. По умолчанию 80.</p>';
           spanEth0 += '<p align=justify>Существует несколько ситуаций, когда полезно использовать эту функцию.</p>';
           spanEth0 += '<p align=justify>- Предположим, в сети работает несколько устройств типа MegaD-2561/328 или любых других, которые воспринимают команды по протоколу HTTP. В случае, когда сервера нет или он недоступен, эта функция позволяет дать команду другому устройству по сети Ethernet. ';
           spanEth0 += 'Например, датчик протечки подключен к одному устройству, а клапан, перекрывающий подачу воды в дом - к другому. Даже если сервер не отвечает, устройство формирует команду по сети на закрытие клапана. Эта функция позволяет в значительной степени улучшить отказоустойчивость критически важных систем.</p>';
           spanEth0 += '<p align=justify>- Есть и другое применение этой функции. В сети может быть несколько устройств, которые бы хотели получать информацию об изменении состояния входов. Например, человек звонит в дверь,  компьютер включает звонок, но одновременно с этим HTTP пакет с командой NetAction получает, к примеру, ';
           spanEth0 += ' телевизор, который выводит информацию о звонке на экран. Конечно, эту команду сможет сформировать и сервер, получив информацию от MegaD-2561, но с применением NetAction это будет: а) быстрее, б) надежнее.</p>';
           spanEth0 += '<p align=justify>- Можно придумать и другие варианты использования NetAction, которые были бы полезны: дублирование сервера, журналирование действий и прочее. К примеру, можно в сети иметь мощный производительный сервер и маленький мини-сервер (на базе роутера), который бы дублировал основные функции большого брата в случае его недееспособности.';
           spanEth0 += '</span></div>';

           spanNaf0  = '<div class="htooltip"><img src="img/emblem-notice.png" width="20px" height="20px"></img><span>';
           spanNaf0 += 'Этот флажок указывает, что NetAction будет вызван ТОЛЬКО при недоступности сервера. По умолчанию вызывается всегда.';
           spanNaf0 += '</span></div>';

           spanM  = '<div class="htooltip"><img src="img/emblem-notice.png" width="20px" height="20px"></img><span>';
           spanM += '<p align=justify><b>Mode</b> - параметр, позволяющий использовать устройство в широком спектре задач. Эта опция определяет режим входа.</p>';
           spanM += '<p align=justify><b>P</b> - устройство реагирует (то есть отправляет сообщения на сервер, выполняет сценарии и т.д.) только при замыкании контакта/выключателя (Пример: <i>http://192.168.0.1/megad.php?pt=4</i>)</p>';
           spanM += '<p align=justify><b>R</b> - устройство реагирует только при размыкании контакта/выключателя. На сервер отправляется дополнительный параметр "m=1". (Пример: <i>http://192.168.0.1/megad.php?pt=4&m=1</i>)</p>';
           spanM += '<p align=justify><b>P&amp;R</b> - устройство реагирует как на замыкание, так и на размыкания контакта.</p>';
           spanM += '<p align=justify><b>С</b> - Click Mode</p><br>&nbsp;<br>';
           spanM += 'В режиме Click Mode:<br>';
           spanM += 'При однократном нажатии на выключатель на сервер передается параметр click=1<br>';
           spanM += '<i>Пример: /md.php?pt=0&click=1&cnt=1</i><br>';
           spanM += 'При двойном нажатии (двойной клик) на сервер передается параметр click=2<br>';
           spanM += '<i>Пример: /md.php?pt=0&click=2&cnt=2</i><br>';
           spanM += 'При удержании клавиши, как и в других режимах, передается параметр m=2<br>';
           spanM += '<i>Пример: /md.php?pt=0&m=2&cnt=3</i><br>';
           spanM += 'После отпускания клавиши после длительного нажатия передается параметр m=1 (как в режиме P&amp;R)<br>';
           spanM += '<i>Пример: /md.php?pt=0&m=1&cnt=3</i><br>&nbsp;<br>';
           spanM += 'Есть изменения и в работе сценария по умолчанию (Action).<br>';
           spanM += 'Теперь допустимо написать так: 7:2|8:2<br>';
           spanM += 'Это означает, что при одинарном клике выполнится 7:2, а при двойном 8:2<br>&nbsp;<br>';
           spanM += '<p align="justify">Необходимо отметить, что в случае одинарного клика (в режиме "C") информация на сервер (или выполнение сценария) происходит <b>с задержкой в 500 мс</b>, которая требуется для фиксации двойного клика.</p>';
           spanM += '<p align=center><b>Обработка длительных нажатий</b></p>';
           spanM += '<p align=justify>Часто возникает задача по-разному реагировать на длительность нажатия. Например, короткое нажатие ';
           spanM += 'включает/выключает свет в одной комнате, а нажатие и удержание (длительное нажатие) включает свет во всех комнатах. ';
           spanM += 'Не всегда удобно и легко делать такую обработку на сервере. Но на помощь приходит наше устройство. В том случае, если ';
           spanM += 'вход (в режиме P или P&amp;R) удерживается более 1,5 секунд, на сервер отправляется второй запрос, в котором передается ';
           spanM += 'параметр m=2. Пример.<br>';
           spanM += '<i>http://192.168.0.1/megad.php?pt=4<br>';
           spanM += '// спустя 1,5 секунды удержания клавиши выключателя<br>';
           spanM += 'http://192.168.0.1/megad.php?pt=4&m=2<br></i></p>';
           spanM += '<p align="justify">Это в значительной степени облегчает обработку таких событий на сервере.</p>';
           spanM += '<p align="justify">Но если необходимости в этой функции нет (к примеру, используются обычные выключатели вместо кнопочных), ';
           spanM += 'и в серверном ПО функция не используется, то обязательно необходимо делать проверку на наличие параметра m=2, чтобы ';
           spanM += 'действия не выполнялись дважды, если пользователь случайно нажал и удерживал кнопку дольше обычного.</p>';
           spanM += '</span></div>';

           spanMisc  = '<div class="htooltip"><img src="img/emblem-notice.png" width="20px" height="20px"></img><span>';
           spanMisc += '<p align=justify>Этот флажок указывает, что при наличии сервера - устройство отправляет на сервер сообщения всегда ';
           spanMisc += 'в режиме P&amp;R, а при его отсутствии Action выполняется только в том режиме, который установлен в Mode. <br>';
           spanMisc += '<i>Данная опция не доступна для Click Mode.</i></p>';
           spanMisc += '</span></div>';

           spanRaw  = '<div class="htooltip"><img src="img/emblem-notice.png" width="20px" height="20px"></img><span>';
           spanRaw += '<p align=justify><b>Raw</b> - параметр отключает встроенную защиту от дребезга. Когда человек нажимает на ';
           spanRaw += 'обычный выключатель или кнопку, то коммутация контактов, когда две металлические пластины внутри выключателя ';
           spanRaw += 'только касаются друг друга, бывает ненадежной. И за этот крайне небольшой промежуток времени, измеряемый ';
           spanRaw += 'миллисекундами, контроллер может зафиксировать десятки пограничных значений "включено-выключено". Этот эффект ';
           spanRaw += 'называется &quot;дребезгом контактов&quot; и может генерировать большое количество ложных событий. С самого ';
           spanRaw += 'начала в контроллере заложена защита от дребезга, которая позволяет выполнять сценарий по умолчанию или ';
           spanRaw += 'отправлять сообщение на сервер только тогда, когда контакт надежен и состояние входа не меняется. Однако в ';
           spanRaw += 'определенных ситуациях эта защита может мешать. Например, в случае подключения к входам устройства энкодера. ';
           spanRaw += 'При вращении ручки энкодера длительность контакта не превышает 10 миллисекунд. Это слишком короткий промежуток ';
           spanRaw += 'времени, чтобы встроенная защита от дребезга смогла распознать срабатывание входа. В этой ситуации можно отключить ';
           spanRaw += 'этот механизм и переложить его на сервер. Другой пример - подключение к контроллеру различных импульсных счетчиков, ';
           spanRaw += 'где длительность импульса не превышает 10-15 миллисекунд.</p>';
           spanRaw += '</span></div>';

           spanDisp  = '<div class="htooltip"><img src="img/emblem-notice.png" width="20px" height="20px"></img><span>';
           spanDisp += '<p align=justify>После того, как хотя бы один дисплей подключен к контроллеру, можно использовать поле Disp. ';
           spanDisp += 'Если в этом поле указать номер порта, к которому подключен дисплей, то информация о состоянии порта будет отображаться на этом дисплее. ';
           spanDisp += 'При изменении состояния порта, информация тут же отображается на дисплее.</p>';
           spanDisp += '<p align=justify>К контроллеру может быть подключено несколько дисплеев. Таким образом, оперируя значением в поле Disp, можно выводить состояние разных портов на разных дисплеях.</p> ';
           spanDisp += '</span></div>';


           text += '<tr><td align="center" valign="middle">';
           text += spanAct0 + '</td><td align="left" valign="middle">';
           text += 'Сценарий по умолчанию (Act):&nbsp;';
           text += '<input id="ecmdXP'+numXP+'" type="text" value="' + ($('#ecmdXP'+numXP).val() || '' ) + 
                   '" onChange="ecmdChanged('+controlPort+');" maxsize="11"/>';
           text += '</td></tr>';

           text += '<tr><td align="center" valign="middle">';
           text += spanAf0 + '</td><td align="left" valign="middle">';
           text += '<input type="checkbox" class="checkbox" id="afXP'+numXP+'" '+ ($('#afXP'+numXP).val() ? 'checked' : '') + 
                   ' onChange="afChanged('+controlPort+');"/>&nbsp;';
           //text += '</td><td align="left" valign="middle">';
           text += '<label id="lblAfXP'+numXP+'" for="afXP'+numXP+'">'+($('#afXP'+numXP).val() ? 'Выполнять всегда, независимо от наличия сервера' : 'Выполнять только если сервер не прописан или недоступен') + '</label>';
           text += '</td></tr>';

           text += '<tr><td align="center" valign="middle">';
           text += spanEth0 + '</td><td align="left" valign="middle">';
           text += 'Сетевой сценарий (Net):&nbsp;';
//           text += '</td></tr><tr><td align="left" valign="middle">';
           text += '<input id="eth'+controlPort+'" type="text" value="' + (ports[controlPort].eth  || '' ) + 
                   '" onChange="ethChanged('+controlPort+');" maxsize="35"/>';
           text += '</td></tr>';

           text += '<tr><td align="center" valign="middle">';
           text += spanNaf0 + '</td><td align="left" valign="middle">';
           text += '<input type="checkbox" class="checkbox" id="naf'+controlPort+'" '+ (ports[controlPort].naf ? 'checked' : '') + 
                   ' onChange="NafChanged('+controlPort+');"/>&nbsp;';
           //text += '</td><td align="left" valign="middle">';
           text += '<label id="lblnaf'+controlPort+'" for="naf'+controlPort+'">'+(ports[controlPort].naf ? 'Вызывать ТОЛЬКО при недоступности сервера' : 'Вызывать всегда') + '</label>';
           text += '</td></tr>';

           text += '<tr><td align="center" valign="middle">';
           text += spanM + '</td><td align="left" valign="middle">';
           text += 'Режим срабатывания (Mode):&nbsp;';
           text += '<select id="m'+controlPort+'" onChange="mChanged('+controlPort+');">';
           text += '<option value="0" ' + ((ports[controlPort].m == 0) ? 'selected' : '') + '>Только при замыкании контакта (P)</option>';
           text += '<option value="1" ' + ((ports[controlPort].m == 1) ? 'selected' : '') + '>При замыкании и размыкании (P&amp;R)</option>';
           text += '<option value="2" ' + ((ports[controlPort].m == 2) ? 'selected' : '') + '>Только при размыкании (R)</option>';
           text += '<option value="3" ' + ((ports[controlPort].m == 3) ? 'selected' : '') + '>С определением двойного нажатия (Click Mode)</option>';
           text += '</td></tr>';

           if (ports[controlPort].m == 3) {
              // опция недоступна для Click Mode
              ports[controlPort].misc = 0;
           } else {
              text += '<tr><td align="center" valign="middle">';
              text += spanMisc + '</td><td align="left" valign="middle">';
              text += '<input type="checkbox" class="checkbox" id="misc'+controlPort+'" '+ (ports[controlPort].misc ? 'checked' : '') + 
                   ' onChange="MiscChanged('+controlPort+');"/>&nbsp;';
              //text += '</td><td align="left" valign="middle">';
              text += '<label id="lblmisc'+controlPort+'" for="misc'+controlPort+'">'+(ports[controlPort].misc ? 'Всегда отправлять в режиме P&amp;R' : 'Выполнять Act в режиме, установленном Mode') + '</label>';
              text += '</td></tr>';
           }

           text += '<tr><td align="center" valign="middle">';
           text += spanRaw + '</td><td align="left" valign="middle">';
           text += '<input type="checkbox" class="checkbox" id="d'+controlPort+'" '+ (ports[controlPort].d ? 'checked' : '') + 
                   ' onChange="RawChanged('+controlPort+');"/>&nbsp;';
           //text += '</td><td align="left" valign="middle">';
           text += '<label id="lbld'+controlPort+'" for="d'+controlPort+'">'+(ports[controlPort].d ? 'Отключить защиту от дребезга' : 'Включить защиту от дребезга') + '</label>';
           text += '</td></tr>';

           text += '<tr><td align="center" valign="middle">';
           text += spanDisp + '</td><td align="left" valign="middle">';
           text += 'Порт дисплея (Disp):&nbsp;';
           text += '<input id="disp'+controlPort+'" type="text" value="' + (ports[controlPort].disp  || '' ) + 
                   '" onChange="dispChanged('+controlPort+');" maxsize="2"/>';
           text += '</td></tr>';


           text += '</table>';

        //-----------------------------------------------------------------------------
        // порт OUT релейный
        } else if (( $('#portTypeXP'+numXP).val() == cPortType_ReleOut ) || ( $('#portTypeXP'+numXP).val() == cPortType_DimmedOut ) || ( $('#portTypeXP'+numXP).val() == cPortType_SimistorOut ) ) {

           spanDef  = '<div class="htooltip"><img src="img/emblem-notice.png" width="20px" height="20px"></img><span>';
           spanDef += '<p align=justify><b>Default state (Def)</b>: состояние порта после включения или перезагрузки устройства. ';
           spanDef += 'В ряде случаев требуется, чтобы отдельные приборы по умолчанию были включены.</p> ';
           spanDef += '</span></div>';


           text += '<tr><td align="center" valign="middle">';
           text += spanDef + '</td><td align="left" valign="middle">';
           text += '<input type="checkbox" class="checkbox" id="d'+controlPort+'" '+ (ports[controlPort].d ? 'checked' : '') + 
                   ' onChange="dChanged('+controlPort+');"/>&nbsp;';
           text += '<label id="lbl'+controlPort+'" for="d'+controlPort+'">'+(ports[controlPort].d ? 'Включено по умолчанию' : 'Выключено по умолчанию') + '</label>';
           text += '</td></tr>';

        //-----------------------------------------------------------------------------
        // порт DSen цифровой вход
        } else if ( $('#portTypeXP'+numXP).val() == cPortType_DigitalSensor ) {

           spanSen  = '<div class="htooltip"><img src="img/emblem-notice.png" width="20px" height="20px"></img><span>';
           spanSen += '<font color=red><b>ВНИМАНИЕ! Положение джампера должно быть нижнее!</b></font><br>';
           spanSen += '<p align=justify><b>Тип устройства (Sen)</b>: Тип подключенного датчика</p>';
           spanSen += '<ul><li><p align=justify><b>DHT11</b> - Цифровой датчик температуры и влажности DHT11</li></p>';
           spanSen += '<li><p align=justify><b>DHT22</b> - Цифровой датчик температуры и влажности DHT22.</p> ';
           spanSen += '<p align=justify>В данный момент функция локального и удаленного термостата для датчиков DHT не реализована. ';
           spanSen += ' В остальном датчики полностью работоспособны. Стоит только заметить, что в работе этих датчиков есть одна ';
           spanSen += ' особенность. Для получения текущего значения необходимо отправить запрос дважды с небольшой задержкой. ';
           spanSen += ' Дело в том, что в момент взаимодействия с датчиком, считываются значения на момент предыдущего опроса. ';
           spanSen += ' Это не ошибка в коде контроллера, это специфика работы самих датчиков.</p></li>';
           spanSen += '<li><p align=justify><b>DS18B20</b> - Цифровой температурный датчик DS18B20 или другой 1-Wire датчик. К одному порту можно подключить один датчик.';
           spanSen += ' В этом режиме Мега может работать также как локальный или удаленный термостат.</p>';
           spanSen += '<p align=justify>Подключение <b>влагозащищенного DS18B20</b>: <b>Желтый</b> провод - данные, подключаем к правой клемме порта. ';
           spanSen += '<b>Черный</b> провод - землю и <b>Красный</b> провод - питание, подключаем к левой клемме порта.</p>';
           spanSen += '<p align=justify>Для тех, кто не знаком с технологией 1-wire, цифровые датчики DS18B20 могут работать без внешнего питания, ';
           spanSen += 'используя так называемое "паразитное" от линии данных. В данном случае описано подключение датчика именно такое, ';
           spanSen += 'с использованием паразитного питания. Производитель рекомендует в этой ситуации соединить вывод питания с землей, ';
           spanSen += 'что мы и сделали (желательно это сделать как можно ближе к датчику). Не стоит беспокоиться по поводу подключения ';
           spanSen += 'датчиков температуры на паразитном питании. В этом режиме они работают ничуть не хуже, чем с питанием, а длина ';
           spanSen += 'провода может быть весьма существенной и измеряться десятками метров. Зато подключение очень удобное - достаточно ';
           spanSen += 'зажать пару проводов в клеммы порта MegaD и вот уже датчик виден из браузера!</p>';
           spanSen += '<p align=justify>Обязательно подключать к датчику питание необходимо при измерении температур выше 100 градусов (например, в сауне). ';
           spanSen += 'Для этого достаточно подсоединить красный провод к клемме питания +3.3В (расположена в левом нижнем углу, слева от ';
           spanSen += 'блока джамперов) исполнительного модуля MegaD-14-IN.</p>';
           spanSen += '<p align=justify>Подключение <b>обычного DS18B20</b> - Берем обычный датчик DS18B20, плоской частью вниз. У него три ножки:</p>';
           spanSen += '<p align=left>Левая - земля. Соединяем ее с левой клеммой входа.</p>';
           spanSen += '<p align=left>Центральная - данные. Соединяем ее с правой клеммой входа.</p>';
           spanSen += '<p align=left>Правая - питание. Согласно рекомендациям производителя соединяем ее с землей.</p></li>'
           spanSen += '<li><p align=justify><b>iButton/Proximity EM Marine</b> -  iButton Reader (считыватель ключей iButton / Proximity EM Marine и других устройство, <b>поддерживающих протокол Dallas/1-wire.</b></p>';
           spanSen += '<p align=justify>Работа с таблетками DS1990A. Считыватель также прекрасно работает как с ключами EM-Marine, так и с ключами, продаваемыми под брендом Vizit RF (что, по всей видимости, одно и то же).</p>';
           spanSen += '<p align=justify><b>Важно!</b> Не все считыватели беспроводных ключей корректно поддерживают протокол Dallas Touch Memory. Например, считыватель RD-3 от VIZIT не полностью совместим с 1-wire, а потому работать не будет.</p></li>';
           spanSen += '<li><p align=justify><b>Шина 1-Wire</b> - Поддержка подключения нескольких датчиков DS18B20 или других 1-Wire к одному порту.</p>';
           spanSen += '<p align=left>Через запрос вида http://192.168.0.14/sec/?pt=32&cmd=list можно получить в ответ примерно следующее:</p>';
           spanSen += '<p align=left>8aad6a070000:32.43;85a56a070000:32.43;</p>';
           spanSen += '<p align=left>адрес:температура;адрес:температура;</p>';
           spanSen += '<p align=justify>Если шина занята конвертацией, то в ответ вернется просто "Busy"</p>';
           spanSen += '<p align=justify>Контроллер автоматически каждые 30 секунд отправляет в шину команду на конвертацию температуры. ';
           spanSen += 'Но можно отправить такой запрос и вручную, вызвав URL вида <br>';
           spanSen += 'http://192.168.0.14/sec/?pt=32&cmd=conv </p></li>';
           spanSen += '<li><p align=justify><b>W26</b> - поддержка считывателей Wiegand-26.<br>';
           spanSen += 'Выбрать Mode: D0 или D1. Для D0 указать, какой порт является линией D1.<br>';
           spanSen += 'Вот так данные приходят на сервер.<br>';
           spanSen += '/md.php?pt=30&wg=ec532f</p>';
           spanSen += '<p align=justify>Внимание! Большинство считывателей (или даже все) для реализации интерфейса Wiegand используют 5В. ';
           spanSen += 'Подключать линии D0/D1 напрямую к контроллеру без платы согласования уровней 5V-3.3V, а такие на "али" ';
           spanSen += 'продаются по 40 руб за шт, нельзя!<br>В силу особенностей работы контроллера, протокол TM/TouchMemory (1-wire) ';
           spanSen += 'для работы со считывателями выглядит более предпочтительным, чем Wiegand. Вероятность считывания некорректных ';
           spanSen += 'данных, опять же, учитывая специфику работы контроллера, для протокола Wiegand несколько выше. Эту проблему ';
           spanSen += 'можно скорее всего решить, используя порты с функцией внешнего прерывания. Но это имеет смысл делать в том ';
           spanSen += 'случае, если на практике существующая реализация будет работать недостаточно хорошо.</p></li>';
           spanSen += '</span></div>';


           text += '<tr><td align="center" valign="middle">';
           text += spanSen + '</td><td align="left" valign="middle">';
           text += '<font color=red><b>ВНИМАНИЕ! Положение джампера должно быть нижнее!</b></font><br>';
           text += 'Тип устройства (DSen):&nbsp;';
           text += '<select id="d'+controlPort+'" onChange="dChanged('+controlPort+');">';
           text += '<option value="1" ' + ((ports[controlPort].d == 1) ? 'selected' : '') + '>DHT11 (Температура и влажность)</option>';
           text += '<option value="2" ' + ((ports[controlPort].d == 2) ? 'selected' : '') + '>DHT22 (Температура и влажность)</option>';
           text += '<option value="3" ' + ((ports[controlPort].d == 3) ? 'selected' : '') + '>DS18B20 или другой 1-Wire датчик</option>';
           text += '<option value="4" ' + ((ports[controlPort].d == 4) ? 'selected' : '') + '>iButton/Proximity EM Marine (считыватель ключей)</option>';
           text += '<option value="5" ' + ((ports[controlPort].d == 5) ? 'selected' : '') + '>Шина 1-Wire</option>';
           text += '<option value="6" ' + ((ports[controlPort].d == 6) ? 'selected' : '') + '>W26 (Считыватель Wiegand26)</option>';
           text += '</td></tr>';
        }
/*

        if (portSettings.pty == 0 || portSettings.pty == 2 || (portSettings.pty == 3 && (portSettings.d == 3 || portSettings.d == 4))) {
            // ecmd(Action)
            text += _('Action:') + ' <input class="tvalue" data-type="ecmd" type="text" 
               data-port="' + index + '" value="' + (portSettings.ecmd || '') + '"  style="width: 70px" maxsize="11"/>, ';
            text += ' <input type="checkbox" class="tvalue" data-type="af" data-port="' + index + '" ' + (portSettings.af   ? 'checked' : '') + '/>';
            // eth(net action)
            text += _('Net:') + ' <input class="tvalue" data-type="eth" type="text" data-port="' + index + '" value="' + portSettings.eth  + '" style="width: 70px" maxsize="35"/>';
            text += ' <input type="checkbox" class="tvalue" data-type="naf" data-port="' + index + '" ' + (portSettings.naf   ? 'checked' : '') + '/>';
        }
  */

        text += '<tr><td align="center" valign="middle">&nbsp;<td align=center valign=middle>';
        text += '    <button class="translateB" id="savePort" onClick="savePort('+controlPort+');">Сохранить настройки порта</button>';
        text += '</td></tr>';

        document.getElementById( "xp" + numXP + "_port_preset" ).innerHTML = text;
    }
    //-----------------------------------------------------------------------------------
    function selectPort ( numXP, portNum ) {
       var spanId = "";
       var text   = "";
       var divMoreId = 'xp' + numXP + '_more';
       var controlPort = portNum;
       var portNumTxt  = portNum;

       if (numXP == 2) {
          controlPort = 15 + portNum;
       }

       var xp = $("#xp"+numXP+"model option:selected").val();
       if ( xp == '2R' ) {
          portNumTxt = portNum + 1; // ??
          if ( numXP == 1 && portNumTxt == 1 ) {
             controlPort = 14;
          } else if ( numXP == 1 && portNumTxt == 2 ) {
             controlPort = 7;
          } else if ( numXP == 2 && portNumTxt == 1 ) {
             controlPort = 29;
          } else if ( numXP == 2 && portNumTxt == 2 ) {
             controlPort = 22;
          }
       }

       imagePorts( numXP );
       spanId = "span_xp" + numXP + "_p" + portNum;
       if ( numXP == 0 ) {
          document.getElementById( spanId ).className = "xt2_port";
       } else {
          document.getElementById( spanId ).className = "circlebutton1";
          text =  'Порт исполнительного модуля: <b>' + portNumTxt + '</b><br>'; 
       }
       text += 'Порт управляющего модуля: <b>' + controlPort + '</b><br>';

       text += '<div id="xp' + numXP + '_port_preset"></div>';



       document.getElementById( divMoreId ).innerHTML = text;
       loadPreset( numXP, portNum );
       //document.getElementById( divMoreId ).show();
    }
    //---------------------------------------------------------------------------------
    function showXPLayer ( numXP, xp ) {
        var text  = "";
        var divId = 'divxp' + numXP;
        var divMoreId = 'xp' + numXP + '_more';
        var startPort = 0;
        var maxCycle  = 14; //??

        text += '<div id="xp' + numXP + '_tbl" class="round1" style="height: 643px; padding: 1em;">';
        text += '<div id="xp' + numXP + '_div_img" class="dxp">';
        text += '  <img name="xp' + numXP + '_img" id="xp' + numXP + '_img" src="mega/MegaD-7I7O-R.gif">';
        text += '<div id="xp' + numXP + 'model_label" class="circlexpnew">';
        if ( numXP != 0 ) {
           text += 'XP'  + numXP;
           startPort = 0;
           //maxCycle  = 14;
           if (xp == '8I7O-S' || xp == '8I7O-SD' || xp =='14-Rv2.0') {
              maxCycle = 15;
           } else if (xp == '2R') {
              maxCycle = 2;
           } else {
              maxCycle = 14;
           }
        } else {
           text += 'XT2';
           startPort = 30;
           maxCycle  = 38;
        }
        text += '</div>';
        for (var m = startPort; m < maxCycle; m++) {
           text += '          <div id="div_xp' + numXP + '_p' + m + '" class="sd7i7or" onClick="selectPort(' + numXP + ',' + m +');">';
           text += '              <span id="span_xp' + numXP + '_p' + m +'" class="circlebutton_darkgreen">&nbsp;</span>';
           text += '          </div>';
        }
        text += '</div>';
        text += '<div id="xp' + numXP + '_more" class="roundmore"></div>';
        text += '</div>';
        document.getElementById( divId ).innerHTML = text;
        //document.getElementById( divMoreId ).hide();
    }
    //---------------------------------------------------------------------------------
    function showXP( numXP ) {
        var xp = "";
        var fon = "";
        var imgName = ""; 
        var tblName = "#xp"+numXP+"_tbl";

        //showXPLayer( numXP );

        if ( numXP != 0 ) {
           xp = $("#xp"+numXP+"model option:selected").val();
           if (!xp) {
              xp = "none";
           }
           fon = "mega/MegaD-" + xp;
        } else {
           xp = "control";
           fon = "mega/megad-2561";
        }

        showXPLayer( numXP, xp );

        imgName = "xp"+numXP+"_img";

        if (xp == '7I7O-R' || xp == '14-IN' || xp == '7I7O-SD' || xp == '8I7O-S' || xp == '8I7O-SD' || xp =='14-Rv2.0') {
           fon = fon + ".gif";
        } else {
           fon = fon + ".jpg";
        }
        
        if (xp == "none") {
           $(tblName).hide();
        } else {
          // инициализируем порты 0-37, если они еще не заданы
          // инициализацию делаем сразу для всех портов
        /*  if ( ports == undefined || ports.length == 0 ) {
             for (var z = 0; z < 38; z++) {
                ports.push({
                    pty:    255, //not configured
                    name:   ('P' + z ),
                    ecmd:   '',
                    eth:    '',
                    m:      0,
                    af:     0,
                    naf:    0,
                    misc:   0,
                    d:      0,
                    act:    '',
                    disp:   '',
                    long:   false,
                    double: false,
                    role:   'state',
                    room:   ''
                });
              }

          }*/

           $(tblName).show();
        }

        setImage( imgName, fon );

        imagePorts( numXP );

    }

    // ------------------------------------------------------------------------------------
    function savePort ( controlPort ) {
        var numXP = 0;
        if ( controlPort < 15 ) {
           numXP = 1;
        } else if ( controlPort < 30 ) {
           numXP = 2;
        } else {
           numXP = 0;
        }

       var newroom = $('#roomXP'+numXP+' option:selected').val();
       var newfnc = $('#fncXP'+numXP+' option:selected').val();
       var newPortType = $('#portTypeXP'+numXP+' option:selected').val();
       var newDefaultAction = $('#ecmdXP' + numXP ).val();
       var newDefaultRunAlways = $('#afXP' + numXP ).val();

       sendTo(null, 'savePort', {  portNum: controlPort, 
                                      room: newroom, 
                                       fnc: newfnc,
                                  portType: newPortType,
                                  defaultAction: newDefaultAction,
                                  defaultRunAlways: newDefaultRunAlways
                                }, 
          function (msg) {
             if (!msg || msg.error) {
                showMessage(msg.error, _('Error'), 'alert');
                return;
             }
          
          }
        );
    }

    //-------------------------------------------------------------------------------------
    // the function loadSettings has to exist ...
    function load(settings, onChange) {
        if (!settings) return;

        if (settings.longPress === undefined) settings.longPress = 400;

        $('.value').each(function () {
            var key = $(this).attr('id');
            // example: select elements with id=key and class=value and insert value
            if ($(this).attr('type') == 'checkbox') {
                $(this).prop('checked', settings[key]).change(function() {
                    if ($('#auth').prop('checked')) {
                        $('#secure').prop('checked', true);
                    }
                    onChange();
                });
            } else {
                if (settings[key] === undefined) settings[key] = '';

                $(this).val(settings[key]).change(function() {
                    onChange();
                }).keyup(function() {
                    onChange();
                });
            }
        });

        ports = settings.ports || [];

        $('#autoDetect').button({
            icons: {primary: 'ui-icon-refresh'}
        }).click(function() {
            autoDetect($('#ip').val(), $('#password').val());
        });

        $('#write').button({
            icons: {primary: 'ui-icon-disk'}
        }).click(function() {
            var port = $('#port').val();
            port = parseInt(port, 10);
            if (!port || port == 80) {
                port = '';
            }
            writeConfig($('#ip').val(), $('#password').val(), port, ports);
        });

        /*$('#savePort').button({
            icons: {primary: 'ui-icon-disk'}
        }).click(function() {
            savePort();
        });*/

        // read if instance is active or enabled
        socket.emit('getState', 'system.adapter.' + adapter + '.' + instance + '.alive', function (err, state) {
            active = common.enabled || (state && state.val);
        });


        getFirmwareVersion();
        getAdapterStates();

        $('#updateFirmware').button({
            icons: {primary: 'ui-icon-refresh'}
        }).click(function () {
            $('#firmware-dialog').dialog( {
                autoOpen: true,
                modal:    true,
                width:    1200,
                height:   600,
                title:    _('Выбор версии прошивки'),
                buttons: [
                    {
                        text: _('Аварийная перепрошивка'),
                        click: function () {
                            updateFirmware('bootloader');
                            $(this).dialog("close");
                        }
                    },
                    {
                        text: _('Перепрошить последней версией'),
                        click: function () {
                            updateFirmware();
                            $(this).dialog("close");
                        }
                    },
                    {
                        text: _('Cancel'),
                        click: function () {
                            $(this).dialog("close");
                        }
                    }
                ]
            });
        });



        $('#buttonsms').button({
            icons: {primary: 'ui-icon-refresh'}
        }).click(function () {
            $('#sms-dialog').dialog( {
                autoOpen: true,
                modal:    true,
                width:    1200,
                height:   600,
                title:    _('Настройки SMS'),
                buttons: [
                    {
                        text: _('OK'),
                        click: function () {
                            $(this).dialog("close");
                        }
                    }
                ]
            });
        });




        /*
        $('#updateFirmwareLatest').button({
            icons: {primary: 'ui-icon-refresh'}
        }).click(function() {
            updateFirmware();
        });
*/

        onchange = onChange;

        readRooms();

        
        $('#add').button({
            icons: {primary: 'ui-icon-plusthick'}
        }).click(function () {
            if (ports.length == 36 || ports.length == 37) {
                ports.push({
                    pty:    2,
                    name:   'P' + (ports.length),
                    ecmd:   '',
                    eth:    '',
                    m:      0,
                    factor: 1,
                    offset: 0,

                    role:   'state',
                    room:   '',
                    func:   ''
                });
            } else {
                ports.push({
                    pty:    0,
                    name:   ('P' + ports.length),
                    ecmd:   '',
                    eth:    '',
                    m:      0,

                    long:   false,
                    double: false,
                    role:   'state',
                    room:   '',
                    func:   ''
                });
            }
            onchange();

            //showPorts();
        });

        $('#ipchange').button({
            icons: {primary: 'ui-icon-note'}
        }).click(function () {
            $('#change_old_ip').val($('#ip').val());
            $('#change_old_password').val($('#password').val());
            $('#change_new_ip').val($('#ip').val());
            $('#change_new_password').val($('#password').val());

            $('#change-dialog').dialog( {
                autoOpen: true,
                modal:    true,
                width:    460,
                height:   270,
                title:    _('Set new password or IP address'),
                buttons: [
                    {
                        text: _('Ok'),
                        click: function () {
                            $(this).dialog("close");
                            var config = {};
                            var changed = false;
                            if ($('#change_old_ip').val() != $('#change_new_ip').val()) {
                                config.eip = $('#change_new_ip').val();
                                changed = true;
                            }
                            if ($('#change_new_password').val() != $('#change_old_password').val()) {
                                config.pwd = $('#change_new_password').val();
                                changed = true;
                            }
                            if (changed) {
                                writeConfig(
                                    $('#change_old_ip').val(),
                                    $('#change_old_password').val(),
                                    undefined, undefined,
                                    config.eip,
                                    config.pwd,
                                    function (err) {
                                        if (err && err.length) {
                                            showMessage(err[err.length - 1], _('Error'), 'alert');
                                        } else {
                                            showMessage(_('OK'), _('Info'), 'info');
                                            if ($('#change_take').prop('checked')) {
                                                if ($('#change_old_ip').val() != $('#change_new_ip').val()) {
                                                    $('#ip').val($('#change_new_ip').val()).trigger('change');
                                                }
                                                if ($('#change_old_password').val() != $('#change_new_password').val()) {
                                                    $('#password').val($('#change_new_password').val()).trigger('change');
                                                }
                                            }
                                        }
                                });
                            } else {
                                showMessage(_('Nothing changed'), 'Info', 'info');
                            }
                        }
                    },
                    {
                        text: _('Cancel'),
                        click: function () {
                            $(this).dialog("close");
                        }
                    }
                ]
            });
        });

        $('#ip').change(function () {
            var val = $(this).val();
            if (!val || val == '0.0.0.0') {
                $('#autoDetect').button('disable');
                $('#write').button('disable');
                $('#ipchange').button('disable');
                $('#updateFirmware').button('disable');
            } else {
                $('#autoDetect').button('enable');
                $('#write').button('enable');
                $('#ipchange').button('enable');
                $('#updateFirmware').button('enable');
            }
        }).keyup(function () {
            $(this).trigger('change');
        }).trigger('change');

        $('#discover').button({
            icons: {primary: 'ui-icon-refresh'}
        }).click(function () {
            if (!active) {
                showMessage(_('Enable adapter first'), 'Warning', 'info');
                return;
            }
            $(this).button('disable');
            sendTo(null, 'discover', null, function (msg) {
                $('#discover').button('enable');
                if (msg && msg.error) {
                    showMessage(msg.error, _('Error'), 'alert');
                } else if (msg && msg.devices) {
                    if (!msg.devices.length) {
                        showMessage(_('Nothing found'), _('Message'), 'alert');
                    } else {
                        var text = '<option value="">' + _('none') + '</option>';
                        for (var d = 0; d < msg.devices.length; d++) {
                            text += '<option value="' + msg.devices[d] + '">' + msg.devices[d] + '</option>';
                        }
                        $('#ips').show().html(text).attr('size', msg.devices.length > 4 ? 5 : msg.devices.length + 1);
                    }
                }
            });
        }).css({'font-size': '0.7em'});

        $('#ips').change(function () {
            $('#ip').val($(this).val()).trigger('change');
        });


        $('#xp1model').change(function () {
            showXP( 1 );
            $('#xp1model').val($(this).val()).trigger('change');
        });

        $('#xp2model').change(function () {
            showXP( 2 );
            $('#xp2model').val($(this).val()).trigger('change');
        });

        // инициализируем картинки при загрузке окна
        var j = showXP( 1 );
        var z = showXP( 2 );
        z = showXP( 0 );


        onChange(false);
    }

    //---------------------------------------------------------------------------------------
    // ... and the function save has to exist.
    // you have to make sure the callback is called with the settings object as first param!
    function save(callback) {
        // example: select elements with class=value and build settings object
        var obj = {};
        $('.value').each(function () {
            var $this = $(this);
            if ($this.attr('type') == 'checkbox') {
                obj[$this.attr('id')] = $this.prop('checked');
            } else {
                obj[$this.attr('id')] = $this.val();
            }
        });

        // Get edited table
        obj.ports = ports;

        /*
        obj['controller.xp1model'] = $('#xp1model option:selected').val();
        obj['controller.xp2model'] = $('#xp2model option:selected').val();
        */
        var xpmodel = $('#xp1model option:selected').val();
        var obj1 = {  val: xpmodel, ack: true };
        socket.emit('setState',  adapter + '.' + instance + '.controller.xp1model', obj1 );

        xpmodel = $('#xp2model option:selected').val();
        obj1 = {  val: xpmodel, ack: true };
        socket.emit('setState',  adapter + '.' + instance + '.controller.xp2model', obj1 );

        /*var newvalue;
        for ( i = 0; i <= 37; i ++ ) {
           newvalue = $('#ports.'+i+'.room option:selected').val();
           obj1 = {  val: newvalue, ack: true };
           socket.emit('setState',  adapter + '.' + instance + '.ports.' + i + '.room', obj1 );
        } */

        callback(obj);
    }

    //--------------------------------------------------------------------------------------
    function autoDetect(ip, pass) {
        if (!active) {
            showMessage(_('Enable adapter first'), 'Warning', 'info');
            return;
        }

        if (window.confirm(_('Information will be merged. Are you sure?'))) {

            $('#write').button('disable');
            $('#autoDetect').button('disable');
            $('#ipchange').button('disable');
            $('#updateFirmware').button('disable');

            sendTo(null, 'detectPorts', {ip: ip, password: pass}, function (msg) {

                $('#write').button('enable');
                $('#autoDetect').button('enable');
                $('#ipchange').button('enable');
                $('#updateFirmware').button('enable');

                if (!msg || msg.error) {
                    showMessage(msg.error, _('Error'), 'alert');
                    return;
                }
                //OFF;OFF/0;OFF/0;25;temp:45.6;temp:45.6/hum:27
                var _ports = msg.response ? msg.response.split(';') : [];
                var settingsPorts =  msg.ports || [];
                var aPorts = [];
                for (var p = 0; p < _ports.length; p++) {
                    aPorts[p] = settingsPorts[p] || {};

                    if (aPorts[p].pn !== undefined) delete aPorts[p].pn;
                    if (aPorts[p].pwm !== undefined) delete aPorts[p].pwm;

                    ports[p] = ports[p] || {};
                    if (aPorts[p].pty == 0) {
                        // input digital port
                        aPorts[p].name    = ports[p].name  || ('P' + p);
                        aPorts[p].ecmd    = aPorts[p].ecmd || '';
                        aPorts[p].eth     = aPorts[p].eth  || '';
                        aPorts[p].af      = aPorts[p].af   || 0; // мое 0.7.0
                        aPorts[p].naf     = aPorts[p].naf  || 0;
                        aPorts[p].m       = aPorts[p].m    || 0;
                        aPorts[p].misc    = aPorts[p].misc || 0;
                        aPorts[p].d       = aPorts[p].d    || 0;
                        aPorts[p].disp    = aPorts[p].disp || 0; // мое 0.7.0

                        // Данная галочка говорит нам, что: если сервер доступен то используется режим P&R. Если нет, то: mode P(0), act 7:2
                        /*if (aPorts[p].misc) {
                            aPorts[p].m = 1;
                        }*/

                        aPorts[p].long    = !!ports[p].long;
                        aPorts[p].double  = !!ports[p].double;
                        aPorts[p].role    = ports[p].role || 'state';
                    } else
                    if (aPorts[p].pty == 1) {
                        // output digital port
                        aPorts[p].name    = ports[p].name || ('P' + p);
                        aPorts[p].m       = aPorts[p].m   || 0;
                        aPorts[p].d       = aPorts[p].d   || 0;
                        if (aPorts[p].m == 1) {
                            ///aPorts[p].pwm     = aPorts[p].pwm  || 0;
                            aPorts[p].fr      = aPorts[p].fr   || 0;
                            aPorts[p].m2      = aPorts[p].m2   || 1;
                            aPorts[p].misc    = aPorts[p].misc || 0;
                        }
                        aPorts[p].role    = ports[p].role || 'button';
                    } else
                    if (aPorts[p].pty == 2) {
                        // ADC port
                        aPorts[p].name    = ports[p].name  || ('P' + p);
                        aPorts[p].ecmd    = aPorts[p].ecmd || '';
                        aPorts[p].eth     = aPorts[p].eth  || '';
                        aPorts[p].m       = aPorts[p].m    || 0;
                        aPorts[p].misc    = aPorts[p].misc || 0;
                        aPorts[p].hst     = aPorts[p].hst  || 0;
                        aPorts[p].naf     = aPorts[p].naf  || 0;

                        aPorts[p].offset  = ports[p].offset || 0;
                        aPorts[p].factor  = ports[p].factor || 1;
                        aPorts[p].role    = ports[p].role   || 'value';
                    } else
                    if (aPorts[p].pty == 3) {
                        // temperature - digital sensor
                        aPorts[p].name    = ports[p].name || ('P' + p);
                        aPorts[p].m       = aPorts[p].m   || (_ports[p].indexOf('hum') != -1 ? 1 : 0);
                        aPorts[p].d       = aPorts[p].d   || 0;
                        aPorts[p].hst     = aPorts[p].hst || 0;
                        aPorts[p].naf     = aPorts[p].naf || 0;
                        aPorts[p].role    = ports[p].role || 'value.temperature';
                        if (aPorts[p].d == 4) {
                            aPorts[p].role    = ports[p].role || 'state';
                        }
                    /*} else if (_ports[p].indexOf('temp:') != -1) {  ///NAUJAS
                        // temperature - internal sensor
                        aPorts[p].pty     = 4;
                        aPorts[p].name    = ports[p].name || ('P' + p);
                        aPorts[p].role    = ports[p].role || 'value.temperature';*/
                    } else
                    if (aPorts[p].pty == 4) {
                        // I2C sensor
                        aPorts[p].name    = ports[p].name || ('P' + p);
                        aPorts[p].m       = aPorts[p].m   || 0;
                        if (aPorts[p].m == 1) {
                            if (aPorts[p].d == 0) {
                                aPorts[p].role    = ports[p].role || 'state';
                            }
                            if (aPorts[p].d == 1) {
                                aPorts[p].d       = aPorts[p].d    || (_ports[p].indexOf('hum') != -1 ? 1 : 0);
                                aPorts[p].misc    = aPorts[p].misc || 0;
                                //aPorts[p].d       = aPorts[p].d    || 0;
                                aPorts[p].role    = ports[p].role || 'value.temperature';
                            }
                            if (aPorts[p].d == 2 || aPorts[p].d == 3) {
                                aPorts[p].role    = ports[p].role || 'value';
                            }
                        }
                        if (aPorts[p].m == 2) {
                            aPorts[p].role    = ports[p].role || 'state';
                        }
                    } else {
                        // unknown settings
                        aPorts[p].pty     = 255;
                        aPorts[p].name    = ports[p].name || ('P' + p + ' - unknown');
                    }
                    aPorts[p].room  = ports[p].room || '';

                }
                ports = aPorts;

                onchange();

                //showPorts();
            });
        }
    }

    //-------------------------------------------------------------------------------------
    function updateFirmware( targetVersion ) {
        var target = '';

        if (!active) {
            showMessage(_('Enable adapter first'), 'Warning', 'info');
            return;
        }

        if (!targetVersion) {
           target = '{"targetVersion":""}';
        } else {
           target = '{"targetVersion":"'+targetVersion+'"}';
        }

        if (window.confirm(_('Firmware will be rewrited. All config will be lost. Are you sure?'))) {
            sendTo(null, 'updateFirmware', target, function (msg) {
               sendTo(null, 'getFirmware', null, function (msg1) {
                    showMessage(_('Firmware updated'), 'Warning', 'info');
                    getFirmwareVersion();
                });

            });
        }
    }


    //----------------------------------------------------------------------------------------------
    function saveSettings() {
        var id = 'system.adapter.' + adapter + '.' + instance;

        var obj = {};
        $('.value').each(function () {
            var $this = $(this);
            if ($this.attr('type') == 'checkbox') {
                obj[$this.attr('id')] = $this.prop('checked');
            } else {
                obj[$this.attr('id')] = $this.val();
            }
        });

        // Get edited table
        obj.ports = ports;

        socket.emit('getObject', id, function (err, oldObj) {
            if (!oldObj) oldObj = {};

            for (var a in obj) {
                oldObj.native[a] = obj[a];
            }

            socket.emit('setObject', id, oldObj, function (err) {
                if (err) {
                    showMessage(err, _('Error'), 'alert');
                    return;
                }
                changed = false;

                $('#save').button('disable');
                $('#saveclose').button('disable');
                $('#close .ui-button-text').html(_('close'));
            });
        });
    }

    //----------------------------------------------------------------------------
    function writeConfig(ip, pass, port, ports, newIp, newPass, callback) {
        if (!active) {
            showMessage(_('Enable adapter first'), 'Warning', 'info');
            return;
        }
        var config = {
            //pwd: pass,  // to change password
            //eip: ip,    // to change the IP address
            port: port
        };

        if (newIp   != undefined) config.eip = newIp;
        if (newPass != undefined) config.pwd = newPass;


        $('#write').button('disable');
        $('#autoDetect').button('disable');
        $('#ipchange').button('disable');
        $('#updateFirmware').button('disable');

        sendTo(null, 'writeConfig', {ip: ip, password: pass, ports: ports, config: config}, function (msg) {

            $('#write').button('enable');
            $('#autoDetect').button('enable');
            $('#ipchange').button('enable');
            $('#updateFirmware').button('enable');

            if (callback) return callback(msg ? msg.error : null);

            var error = (msg && msg.error && msg.error.length) ? msg.error[msg.error.length - 1] : null;

            if (!msg || error) {
                showMessage(error, _('Error'), 'alert');
                return;
            } else {
                showMessage(_('OK'), _('Success'), 'info');
                if (changed) saveSettings();
            }
        });
    }

</script>

<!-- you have to put your config page in a div with id adapter-container -->
<div id="adapter-container">

    <input type="text" id="tmp"/>
    <input type="text" id="portState0"/>
    <input type="text" id="portState1"/>
    <input type="text" id="portState2"/>
    <input type="text" id="portState3"/>
    <input type="text" id="portState4"/>
    <input type="text" id="portState5"/>
    <input type="text" id="portState6"/>
    <input type="text" id="portState7"/>
    <input type="text" id="portState8"/>
    <input type="text" id="portState9"/>
    <input type="text" id="portState10"/>
    <input type="text" id="portState11"/>
    <input type="text" id="portState12"/>
    <input type="text" id="portState13"/>
    <input type="text" id="portState14"/>
    <input type="text" id="portState15"/>
    <input type="text" id="portState16"/>
    <input type="text" id="portState17"/>
    <input type="text" id="portState18"/>
    <input type="text" id="portState19"/>
    <input type="text" id="portState20"/>
    <input type="text" id="portState21"/>
    <input type="text" id="portState22"/>
    <input type="text" id="portState23"/>
    <input type="text" id="portState24"/>
    <input type="text" id="portState25"/>
    <input type="text" id="portState26"/>
    <input type="text" id="portState27"/>
    <input type="text" id="portState28"/>
    <input type="text" id="portState29"/>
    <input type="text" id="portState30"/>
    <input type="text" id="portState31"/>
    <input type="text" id="portState32"/>
    <input type="text" id="portState33"/>
    <input type="text" id="portState34"/>
    <input type="text" id="portState35"/>
    <input type="text" id="portState36"/>
    <input type="text" id="portState37"/>
    <table><tr><td><img src="megad.png"></td><td><h3 class="translate">MegaD-2561 adapter settings</h3></td></tr></table>

    <table>
        <tr><td class="translate" style="text-align: right">IP:</td>
            <td><input  class="value" id="ip"/></select></td>
            <td style="padding-left: 10px">
                <select id="ips" style="display:none"></select>&nbsp;
                <button id="discover" class="translateB">Find devices</button>
            </td>
            <td colspan=2 style="padding-left: 10px">
                <button id="buttonsms" class="translateB">SMS Setup</button>
            </td>
        </tr>
        <tr><td class="translate" style="text-align: right">MegaD Name:</td>
            <td><input  class="value" id="name"/></td>
            <td class="translate" style="text-align: right">Poll interval (sec):</td>
            <td colspan=2><input  class="value" id="pollInterval"  maxlength="3"/></td>
        </tr>
        <tr><td class="translate" style="text-align: right">Current firmware version:</td>
            <td><input readonly class="value" id="fw_version"  maxlength="10"/></td>
            <td class="translate" style="text-align: right">Last known firmware version:</td>
            <td><input readonly class="value" id="fw_version_last_known"  maxlength="10"/></td>
            <td><button class="translateB" id="updateFirmware">Update Firmware</button></td>
        </tr>
        <tr><td class="translate" style="text-align: right">ioBroker Web Port:</td>
            <td><input  class="value" id="port" maxlength="5"/></td>
            <td class="translate" style="text-align: right">Long press detect (ms):</td>
            <td colspan=2><input  class="value" id="longPress" maxlength="4"/></td>
        </tr>
        <tr><td class="translate" style="text-align: right">MegaD Password:</td>
            <td><input  class="value" id="password" maxlength="3"/></td>
            <td class="translate" style="text-align: right">Double press detect (ms):</td>
            <td colspan=2><input  class="value" id="doublePress" maxlength="4"/></td>
        </tr>
    </table>
    <!-- <button class="translate" id="add">Add new port</button> -->
    <button class="translateB" id="autoDetect">Auto detect ports</button>
    <button class="translateB" id="write">Write config to device</button>
    <button class="translateB" id="ipchange">Change ip or password</button>

    <br>&nbsp;XP1:
    <select id="xp1model" class="value">
       <option value="none">Не подключено</option>
       <option value="7I7O-R">Релейный модуль 7I7O-R</option>
       <option value="7I7O-SD">Симисторный модуль 7I7O-SD</option>
       <option value="8I7O-S">Симисторный модуль 8I7O-S</option>
       <option value="8I7O-SD">Симисторный модуль 8I7O-SD</option> 
       <option value="14-IN">Модуль входов 14-IN</option>
       <option value="14-Rv1.0">Релейный модуль 14-R версия 1.0</option>
       <option value="14-Rv2.0">Релейный модуль 14-R версия 2.0</option>
       <option value="2R">Релейный минимодуль 2-R</option>
    </select>

    &nbsp;&nbsp;XP2:
    <select id="xp2model" class="value">
       <option value="none">Не подключено</option>
       <option value="7I7O-R">Релейный модуль 7I7O-R</option>
       <option value="7I7O-SD">Симисторный модуль 7I7O-SD</option>
       <option value="8I7O-S">Симисторный модуль 8I7O-S</option>
       <option value="8I7O-SD">Симисторный модуль 8I7O-SD</option> 
       <option value="14-IN">Модуль входов 14-IN</option>
       <option value="14-Rv1.0">Релейный модуль 14-R версия 1.0</option>
       <option value="14-Rv2.0">Релейный модуль 14-R версия 2.0</option>
       <option value="2R">Релейный минимодуль 2-R</option>
    </select>
    <br>

    <div id="divxp1"></div>
    <div id="divxp2"></div>
    <div id="divxp0"></div>

    <table>
        <thead>
        <col width="20px" />
        <col width="100px" />
        <col width="100px" />
        <col width="100px" />
        <col width="110px" />
        <col width="100px" />
        <col width="70px" />
        <col width="*"/>
        </thead>
        <tbody id="ports"></tbody>
    </table>

    <div id="change-dialog" style="display: none">
        <table>
            <tr><td class="translate">Take new settings into config:</td><td><input type="checkbox" checked id="change_take"/></td></tr>
            <tr><td class="translate">Old IP:</td>      <td><input style="width: 100%" id="change_old_ip"/></td></tr>
            <tr><td class="translate">Old password:</td><td><input style="width: 100%" id="change_old_password"/></td></tr>
            <tr><td class="translate">New IP:</td>      <td><input style="width: 100%" id="change_new_ip"/></td></tr>
            <tr><td class="translate">New password:</td><td><input style="width: 100%" id="change_new_password"/></td></tr>
        </table>
    </div>

    <div id="firmware-dialog" style="display: none">
        <table border=1>
           <tr>
             <td>Версия прошивки</td>
             <td>Дата и время</td>
             <td>Описание</td>
             <td>Прошивка</td>
           </tr>
           <tr>
             <td><b>4.19b5</td>
             <td>15.11.2017</td>
             <td><p align=justify><p align=justify>Добавлено управление группой.</p>
                           <p align=justify>Поле Group теперь доступно также для режима "SW", что делает возможным объединение нескольких портов в группу.<br>
                           Поле Group может принимать значения от 0 до 99.<br>
                           Управление группой, пример (включить все порты группы "1"): <b>g1:1</b><br>
                           <b>http://192.168.0.14/sec/?cmd=g1:1</b><br>
                           Доступные команды: (1 - включить, 0 - выключить, 2 - переключить)
                 </p>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.19b5');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.19b2</td>
             <td>11.11.2017</td>
             <td><p align=justify>Добавлен режим "SW LINK" (связывание выходов в группы для безопасного управления такими нагрузками, как приводы на два направления).</p>
                 <p align=justify>Теперь существует возможность "залинковать" два или более выходов. Эта функция предполагает, что если один из связанных портов включен, 
                                  то любой другой включить уже нельзя. Другими словами, нельзя одновременно включить несколько связанных 
                                  портов. В конкретный момент времени может быть включен только один порт из связанной группы.</p>
                 <img src="firmware/megad-2561-sw-link.png"><br>
                 <p align=justify>Выбираем режим порта (Mode) "SW LINK"</p>
                 <p align=justify>Указываем номер группы, к которому принадлежит порт. Не имеет значение, какой будет указан номер. 
                                  Но если мы хотим создать группу, то один и тот же номер должен быть указан для всех портов, 
                                  входящих в эту группу, например: "1".</p>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.19b2');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.18b9</td>
             <td>09.11.2017</td>
             <td><p align=justify>Для дисплея SSD1306 IP-адрес помимо P30 также теперь выводится и на "системном" дисплее</p>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.18b9');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.18b7</td>
             <td>07.11.2017</td>
             <td><p align=justify>Реализована команда <b>"2"</b> (переключение) для управления дисплеем SSD1306</p>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.18b7');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.18b6</td>
             <td>02.11.2017</td>
             <td><p align=justify>Реализована команда <b>get</b> для всех портов в режиме PCA9685:<br>
                 <b>http://192.168.0.14/sec/?pt=31&cmd=get</b></p>
                 <p align="justify">Реализована команда <b>get</b> для каждого порта в режиме MCP230XX<br>
                 <b>http://192.168.0.14/sec/?pt=31&ext=15&cmd=get</b></p>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.18b6');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.18b5</td>
             <td>01.11.2017</td>
             <td><p align=justify>Добавлена поддержка микросхемы PCA9685 (16 ШИМ каналов с разрешением 12-бит)<br>
                 Для SDA-порта выбираем тип PCA9685<br>
                 <img src="firmware/megad-2561-backup-outs.megad-2561-pca9685.png"><br>
                 Теперь у SDA-порта появляется ссылка Ext-IO<br>
                 <img src="firmware/megad-2561-backup-outs.megad-2561-pca9685-extio.png"><br>
                 Перейдя по ссылке, можно увидеть список доступных ШИМ-каналов.<br>
                 <img src="firmware/megad-2561-backup-outs.megad-2561-pca9685-extio-list.png"><br>
                 Выбрав нужный порт, можно задать уровень ШИМ (от 0 до 4095). 
                 <img src="firmware/megad-2561-backup-outs.megad-2561-pca9685-setpwm.png"><br>
                 </p><p align="justify">Также обеспечена обработка этих портов в сценариях и командах сервера.<br>
                 Пример: <b>http://192.168.0.14/sec/?cmd=10:2;31e3:4000;31e2:2000;11:2</b><br>
                 31e3:4000 (31 - SDA-порт, к которому подключена микросхема, e3 - порт P3 расширитеря, 4000 - значение ШИМ)</p>
                 <p align="justify">Для данных портов поддерживается команда "get".<br>
                 Пример: <b>http://192.168.0.14/sec/?pt=31&ext=15&cmd=get</b>
                 </p><p align="justify">Частота ШИМ - одна на все каналы, значение по умолчанию 200 Гц, на данный момент указание
                   другого значения пока не реализовано.</p>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.18b5');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.18b4</td>
             <td>17.10.2017</td>
             <td><p align=justify>Исправлено отображение отрицательных температур для датчиков BME280, HTU21D</p>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.18b4');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.18b2</td>
             <td>17.10.2017</td>
             <td><p align=justify>Добавлена команда 's' для сохранения в энергонезависимой памяти состояния выходов (SW/PWM).</p>
                 <p align=justify>Иногда возникают такие задачи, которые требуют, чтобы после аварийного выключения питания 
                    контроллер восстанавливал состояние своих выходов без участия сервера. Очевидное на первый взгляд решение, 
                    сохранять состояние портов в энергонезависимой памяти микроконтроллера при каждом переключении выходов, 
                    в действительности не слишком удачное. У ячеек EEPROM есть хоть и довольно большой, но конечный ресурс записи, 
                    а в некоторых задачах порты переключаются очень часто. Значит, необходимо сохранять состояние выходов только 
                    в момент выключения устройства.</p>
                 <p align=justify>Есть довольно интересный вариант решения этой задачи. Известно, что современные импульсные БП, 
                    такие как MeanWell DR-(60/30/15)-12, которые часто используются для питания модулей, после отключения 220В 
                    отрубаются не сразу, а примерно через секунду-полторы. Это то самое время, когда состояние портов и можно сохранить. 
                    Реализация очень простая. Необходимо задействовать любой свободный вход, подключив к нему U-Sensor, 
                    который соединить с клеммами входного напряжения 220В блока питания. Когда напряжение 220В пропадет, 
                    контроллер это зафиксирует.</p>
                <p align=justify>Настройка порта, к которому подключен датчик напряжения, может выглядеть следующим образом.<br>
                   <img src="firmware/megad-2561-backup-outs.gif"></p>
                <p align=justify> Флажок рядом с полем сценария (Act) запускает сценарий независимо от наличия сервера.<br>
                   Mode: R - запускает сценарий при размыкании порта (отключении электроэнергии)<br>
                         "s" - это и есть команда сохранения состояния выходов.</p>
                <p align=justify>При включении контроллера, он восстановит состояние портов на момент сохранения.</p>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.18b2');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.18b1</td>
             <td>16.10.2017</td>
             <td><p align=justify>
                  По команде cmd=all отображается состояние только собственных портов контроллера и не отображаются порты модулей-расширителей.
                  Изменение сделано для сервера iobroker, иначе были ошибки.
                 </p>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.18b1');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.17b8</td>
             <td>13.10.2017</td>
             <td><p align=justify>При включенном режиме Smooth для PWM-порта передача параметра cnt=0 позволяет менять яркость моментально.</p>
                 <p align=justify>Краткое пояснение. Для ШИМ (PWM) портов есть режим Smooth. Это когда можно задать скорость, например, 
                     разгорания и затухания лампочки. Так, при значении Smooth равным 1 лампочка от 0 до 255 (максимальное значение ШИМ) 
                     разгорается примерно за 1 секунду. Но скоростью изменения яркости при включенном режиме Smooth можно оперативно 
                     управлять с помощью параметра "cnt". Например: <b>http://192.168.0.14/sec/?pt=13&pwm=255&cnt=3</b> <br>
                     Не важно, что указано в поле Smooth. Изменение яркости от 0 до 255 произойдет за 3 секунды. Однако cnt=0 ранее 
                     не приводило к моментальному изменению яркости. Яркость в этом случае менялась согласно настройкам Smooth. 
                     Теперь даже при включенном режиме Smooth сервер может изменять яркость моментально с помощью cnt=0.
                 </p>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.17b8');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.17b6</td>
             <td>04.10.2017</td>
             <td><ul><li>Исправлена ошибка версии 4.17b5: при выборе SCL "0", остальные настройки не появлялись.</li>
                     <li>Добавлена поддержка микросхемы расширителя MCP23017</li>
                     <li>Добавлен выбор режима дополнительных портов (IN/OUT) MCP230XX</li>
                     <li>Добавлена работа с прерываниями MCP230XX</li>
                 </ul>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.17b6');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.17b5</td>
             <td>03.10.2017</td>
             <td><ul><li>При выборе типа порта I2C/SDA по умолчанию в поле SCL пусто</li></ul>
                <p align=justify>"ANY" можно использовать с датчиками, но не с теми устройствами, которые требуют инициализации. 
                    MCP230XX требует инициализации, в EEPROM порта хранится информация о типах расширенных портов. 
                    Использовать ANY с расширителем не получится. Вы можете выбрать тип устройства MCP230XX, но затем точно также 
                    запрашивать данные с датчиков, которые висят на этой шине через i2c_dev=xxx (кроме BMPx80, 
                    для которых также хранятся калибровочные коэффициенты в EEPROM). 
                </p>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.17b5');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.17b4</td>
             <td>29.09.2017</td>
             <td>Добавлена полноценная поддержка MCP23017<br>&nbsp;<br>
                  <p align=justify>
                   <img src="firmware/megad-2561-mcp-17.gif">
                  </p>
                  <p align=justify>Прошивка автоматически определяет тип подключенного устройства (MCP23008 или MCP23017). 
                      В Web-интерфейсе отображаются все 16 портов для MCP23017. Добавлен вывод типа порта в общем списке.
                  </p>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.17b4');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.17b3</td>
             <td>25.09.2017</td>
             <td><ul>
                <li>Исправлены ошибки версии 4.17b2:<br>
                   1. После установки, значение INT нельзя удалить, только заменить на другой порт.
                      Значение запоминается в конфигурации даже если основной порт перевести в NC и проделать с нуля процедуру по настройке расширителя.<br>
                   2. Порты расширителя нельзя перевести в OUT (не запоминает).<br>
                   3. Если основной порт перевести в NC, то меню с расширенными портами не пропадает.
                </li>
                <li>Расширена поддержка MCP23017.<br>
                Теперь первые 8 портов можно настраивать IN/OUT (также, как и для MCP23008), 
                вторые 8 портов автоматически конфигурируются как IN. В Web-интерфейсе их не видно, 
                но при замыкании/размыкании на сервер будут отправляться сообщения ext8-ext15.<br>&nbsp;<br>

                INTA/INTB для MCP23017 нужно подключать к одному порту INT, который указывается в настройках SDA порта. 
                Вход, к которому подключаются линии INT(A)/INTB нужно настроить как простой IN, но обязательно поставить флажок Raw. 
                Повторю, что в качестве такого входа можно использовать любой из доступных портов контроллера.
                </li></ul>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.17b3');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.17b2</td>
             <td>22.09.2017</td>
             <td>Добавлена поддержка режима IN для расширителя MCP23008
                  <p align=justify>
                   <img src="firmware/megad-2561-mcp-in.gif">
                  </p>
                 <p align=justify>
                   В поле INT указываем номер порта, к которому подключена линия INT расширителя. Это может быть ЛЮБОЙ порт.
                   Указанный порт конфигурируем как IN (режим P).
                 </p>
                  <p align=justify>
                   <img src="firmware/megad-2561-mcp-in-ext-list.gif">
                  </p>
                  <p align=justify>
                     Далее переходим по ссылке Ext-IO и заходим в настройки расширенного порта
                  </p>
                  <p align=justify>
                   <img src="firmware/megad-2561-mcp-in-type.gif">
                  </p>
                  <p align=justify>Выбираем тип порта</p>
                  <p align=justify>Теперь при замыкании входа P0 на сервер поступает сообщение вида:<br>
                  <i><b>/script.php?pt=22&ext0=1</b></i></p>
                  <p align=justify>При размыкании<br>
                  <i><b>/script.php?pt=22&ext0=0</b></i></p>
                  <p align=justify>Поскольку работа с подобными входами строится несколько иначе, чем с родными входами 
                     контроллера, то при одновременном замыкании нескольких входов приходит одно сообщение вида<br>
                     <i><b>/script.php?pt=22&ext0=1&ext1=1</b></i></p>
                  <p align=justify>Вход контроллера, куда подключен пин прерывания расширителя (INT), должен быть настроен в режим "P". 
                     Но на сервер в любом случае будут отправляться сообщения как о замыкании, так и о размыкании входов расширителя. 
                     Причем в единицу времени один порт может замыкаться, другой размыкаться.<br>
                     <i><b>/script.php?pt=22&ext0=1&ext1=0</b></i></p>
                  <p align=justify>Вот, почему в запросе меняются не только значения параметров (0, 1), но и их имена (ext0, ext1). 
                      Это, однако, никоим образом не усложняет обработку этих сообщений на сервере.</p>
                  <p align=justify>Примечательно, что все описанное работает и с MCP23017. Но только для половины портов (0-7, INTA).
                      Добавлю, что входы на расширителях удобно использовать для подключения различных датчиков, 
                      извещателей или даже выключателей света. Но если требуется высокоскоростная работа (в т.ч. режим Raw), 
                      на очень-очень ответственных задачах, то лучше использовать родные входы контроллера. 
                      Они обрабатываются существенно быстрее.
                  </p>
                  <p align=justify>Обработка событий от входов расширителя возможна только с помощью сервера. 
                      Неразумно было бы хранить дополнительные настройки портов расширителя в памяти контроллера. 
                      Может быть, правильнее было бы разместить в модуле расширителя свою микросхему EEPROM. </p>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.17b2');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.16b8</td>
             <td>20.09.2017</td>
             <td>С некоторыми условиями добавлена поддержка пауз в командах, поступающих извне (например, от сервера или от другого устройства):
                 <p align=justify>Добавлена поддержка пауз в командах/ответах сервера, yо есть одна деталь. Одновременно может выполняться только одна последовательность команд, содержащая паузу. 
                 Если в момент выполнения последовательности команд, например: 7:1;p100;7:0 от сервера поступит новый набор команд, содержащий паузу, то выполнение первой последовательности будет остановлено. 
                 Но если же последующие команды не будут содержать паузы, то первая последовательность выполнится в полном объеме. Другими словами, несколько параллельно выполняющихся пауз во внешних командах (от сервера) быть не может. 
                 Все это никаким образом не касается сценариев по умолчанию. При использовании сценариев, а также при выполнении команды "d" никаких ограничений по одновременному выполнению последовательностей команд с паузами нет. </p>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.16b8');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.16b6</td>
             <td>18.09.2017</td>
             <td>ИК-передатчик теперь поддерживается на шести портах: P10, P12, P13, P25, P27, P28
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.16b6');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.16b3</td>
             <td>24.08.2017</td>
             <td><ul>
               <li>В Web-интерфейсе для SDA-порта отображается состояние всех каналов расширителя MCP23008.<br>
                   Также возможно сделать запрос вида: <a href=http://192.168.0.14/sec/?pt=31&cmd=get>http://192.168.0.14/sec/?pt=31&cmd=get</a>
                   <br>
                   <img src="firmware/4-16b3.gif"><br>
               </li>
               <li>Улучшена работа функции srv-loop</li>
               </ul>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.16b3');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.15b9</td>
             <td>30.06.2017</td>
             <td>Увеличено поле Net и исправлена ошибка в работе функции Net в некоторых режимах
                  <br><font color=red><b>Обновление только со сбросом настроек!</b></font>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.15b9');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.15b7</td>
             <td>20.06.2017</td>
             <td>Исправлена ошибка в работе со считывателями, передающими данные по протоколу Wiegand26
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.15b7');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.15b6</td>
             <td>14.06.2017</td>
             <td><ul><li>Улучшена работа Act при установленном флажке обязательного выполнения сценария</li>
                     <li>Увеличен размер буфера для ИК-команд</li>
                     <li>Добавлена поддержка команд '3' и '4' для 1-wire модулей на базе DS2413</li>
                 </ul>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.15b6');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.15b3</td>
             <td>11.05.2017</td>
             <td>Добавлена поддержка датчика освещенности MAX44009
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.15b3');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.15b2</td>
             <td>09.05.2017</td>
             <td><ul><li>Добавлена команда для отображения крупно цифр на дисплеях SSD1306</li>
                     <li>Изменен режим работы TSL2591</li>
                 </ul>
                 <a href=http://ab-log.ru/smart-house/ethernet/megad-2561-ssd1306 target="_blank">Подробнее</a>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.15b2');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.14b8</td>
             <td>23.04.2017</td>
             <td>Добавлена отправка на сервер "mdid" при старте контроллера (st=1)
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.14b8');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.14b7</td>
             <td>21.04.2017 18:52</td>
             <td>- Добавлена поддержка 'd' (выполнение сценария, прописанного в Act) в командах сервера 
                   (ранее эта функция работала только в ответах сервера на сообщения контроллера).   <br>
                    Пример: <i>?pt=7&cmd=d</i> (выполнится сценарий, прописанный в Act для порта P7) <br>
                    Эту особенность можно иногда использовать для работы с паузами в командах сервера.<br>
                  - Улучшена стабильность работы контроллера. Ранее тип портов P29/P30 мог в определенных ситуациях самопроизвольно меняться на IN.
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.14b7');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.14b5</td>
             <td>17.04.2017</td>
             <td>- Улучшена стабильность работы с 1-wire bus<br>
                 - Незначительные улучшения работы srv-loop
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.14b5');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.14b2</td>
             <td>08.04.2017 15:10</td>
             <td>Добавлена возможность управления яркостью дисплея<br>
                 <img src="firmware/web-disp-brightness.gif"><br>
                 Появилось поле "Bright".<br>
                 Значение по умолчанию теперь: 127 (ранее было почти максимальное).<br>
                 Допустимый диапазон: 2-254 (2 -минимальная яркость, 254 - максимальная яркость).<br>
                 Примечательно, что яркостью можно управлять с помощью стандартных команд.<br>
                 Например: <i>cmd=34:100</i><br>&nbsp;<br>
                 Это позволяет менять яркость в зависимости от освещенности в комнате.
                 Причем сервер может менять яркость плавно. Например, нижеприведенный скрипт PHP  
                 в бесконечном цикле увеличивает и уменьшает яркость дисплея, линия SDA которого подключена к P34.
                 <pre> 
$dir = 0;
$brightness = 2;
while(1)
{
   if ( $dir == 0 ) $brightness++;
   else if ( $dir == 1 ) $brightness--;

   file_get_contents("http://192.168.0.14/sec/?cmd=34:$brightness");

   if ( $brightness == 254 ) $dir = 1;
   else if ( $brightness == 2 ) $dir = 0;
}
</pre>
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.14b2');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.14b1</td>
             <td>06.04.2017 18:17</td>
             <td>Небольшие исправления в функции включения/выключения дисплея стандартными командами (обновление со сбросом EEPROM!)
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.14b1');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.13b8</td>
             <td>30.03.2017 17:52</td>
             <td>Улучшена работа с MCP23008
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.13b8');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.13b7</td>
             <td>25.03.2017</td>
             <td>Исправлена ошибка, в результате которой сценарий мог не выполняться, если начинался с паузы.
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.13b7');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.13b6</td>
             <td>24.03.2017</td>
             <td>Исправлена ситуация, когда контроллер не выполнял команды сервера, если тот 
                 передавал вместе с командами метку UTF-8 BOM.
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.13b6');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.13b5</td>
             <td>23.03.2017 10:43</td>
             <td>Улучшена стабильность работы устройства в случае некорректного поведения сервера
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.13b5');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.13b4</td>
             <td>22.03.2017 10:43</td>
             <td>Отображение информации на дисплее SSD1306 можно включать/выключать с помощью стандартных команд сценариев "0" и "1" (например, 35:0)<br>
             <i>Пример.</i><br>
             Линия SDA дисплея подключена к P35<br>
             (Act/?cmd=) 35:0 - выключить дисплей; 35:1 - включить дисплей.
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.13b4');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.13b3</td>
             <td>20.03.2017 18:44</td>
             <td>Исправлена ошибка: контроллер при подключенном сервере не отрабатывает действие при поднесении ТМ ключа
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.13b3');">Прошить</button></td>
           </tr>
           <tr>
             <td><b>4.13b2</td>
             <td>19.03.2017 22:00</td>
             <td>Добавлена поддержка датчиков температуры/давления/(влажности) Bosch BMP280/BME280<br>
                 <img src="firmware/megad-2561-bmx280.gif"><br>
                 Команды для считывания отдельных значений (примеры):<br>
                 Атмосферное давление (мм.рт.ст.)<br>
                 http://192.168.0.14/sec/?pt=31&scl=30&i2c_dev=bmx180<br>
                 Температура<br>
                 http://192.168.0.14/sec/?pt=31&scl=30&i2c_dev=bmx280&i2c_par=1<br>
                 Влажность<br>
                 http://192.168.0.14/sec/?pt=31&scl=30&i2c_dev=bmx280&i2c_par=2<br>
                 Атмосферное давление, температура, (влажность)<br>
                 http://192.168.0.14/sec/?pt=31&cmd=get<br>&nbsp;<br>
                 Ввиду необходимости хранения калибровочных коэффициентов, 
                 на одной шине не должно висеть одновременно BMP180 и BMx280 несмотря на то, что у них разные адреса.
             </td>
             <td><button class="translate" id="updateFirmwareLatest" onClick="updateFirmware('4.13b2');">Прошить</button></td>
           </tr>
        </table>
        <br>&nbsp;<br>
        <div class="round">
             <b>В процессе загрузки новой прошивки произошел сбой. Устройство не отвечает. Все пропало?</b><br>
             <i>Режим восстановления</i><br><p>
             Нет, ничего не пропало! Для таких случаев предназначен особый режим. 
             Дело в том, что в момент включения устройства, загрузчик передает управление основной программе не сразу, 
             а спустя примерно секунду. В течение этой секунды он ждет специального пакета от скрипта прошивки. 
             Если такой пакет получен, автоматически начнется процесс прошивки заново. То есть алгоритм следующий:<br>
             <b>1. Нажимаем кнопку "Аварийная прошивка"</b><br>
             Скрипт начнет постоянно слать в сеть специальные пакеты.<br>
             <b>2. Выключаем "сломанное" устройство и включаем его снова.</b>
             Скрипт автоматически соединится с программой загрузчика и попытается перепрошить устройство заново.
       </div>
    </div>


    <div id="sms-dialog" style="display: none">
        <p align="justify">Для отправки SMS используется сервис megadjt.sms.ru. <br>
                           Вам необходимо указать в настройках драйвера SMS API KEY, который Вы должны получить на указанном сервисе.<br>
                           После регистрации на сервисе Вы получите скидку 10% на первый месяц.<br>
                           Если Вы уже зарегитрированы на SMS.RU - перейдите в свой профиль и введите в нем промокод <b>megadjt</b>.<br>
                           Отправка SMS на собственный номер - бесплатная.<br>
                           Возможна отправка на несколько номеров, для этого они должны быть указаны через запятую.<br>
                           Номера телефонов вводятся в формате 79031234567.<br>
                           Обратите внимание, что по умолчанию отправка смс с одинаковым текстом ограничена по количеству. 
                           При необходимости это ограничение можно отключить в профиле на сайте.<br>
                           Отправка производится только если включена галочка "Включить отправку SMS"</p>
         <p align=justify>
              Вы также можете использовать драйвер для отправки собственных SMS. Для отправки текста нужно
              сохранить текст в переменную драйвера <b>sms.text</b> с параметром <b>(ack: false)</b>.</p>
                           <p align=center>
                                    <a href="http://megadjt.sms.ru" target="_blank">Получить API KEY</a>
                           </p>
        <table>
            <tr><td class="translate" style="text-align: right">Включить отправку SMS:</td>
                <td><input type="checkbox" id="sms_enabled"/></td></tr>

            <tr><td class="translate" style="text-align: right">SMS API Key:</td>
                <td><input class="value" id="sms_apiKey"  size="100" maxlength="200"/></td></tr>

            <tr><td class="translate" style="text-align: right">Отправлять SMS на номера: </td>
                <td><input class="value" id="sms_phones"  size="100" maxlength="200"/></td></tr>

        </table>

    </div>


</div>
</html>
